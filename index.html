<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>EcoRush</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      overflow: hidden;
      user-select: none;
      margin: 0;
      padding: 0;
    }
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700;800&display=swap');

    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #10b981 0%, #0d9488 50%, #0891b2 100%);
    }
    .game-font { font-family: 'Fredoka', sans-serif; }

    /* BACKGROUND IMAGES (LOCAL REPO PATHS) */
    .bg-home    { background: url("background-ui/home.png") center/cover no-repeat; }
    .bg-map     { background: url("background-ui/map.png") center/cover no-repeat; }
    .bg-shop    { background: url("background-ui/shop.png") center/cover no-repeat; }

    .bg-game-easy    { background: url("background-ui/game-easy.png") center/cover no-repeat; }
    .bg-game-normal  { background: url("background-ui/game-normal.png") center/cover no-repeat; }
    .bg-game-hard    { background: url("background-ui/game-hard.png") center/cover no-repeat; }
    .bg-game-extreme { background: url("background-ui/game-extreme.png") center/cover no-repeat; }

    /* overlay for readability */
    .screen::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.55));
      pointer-events:none;
      z-index:0;
    }
    .screen > *{ position:relative; z-index:1; }

    /* =========================
       CARTOONY BUTTON SYSTEM
       (inspired by your image)
       ========================= */
    :root{
      --btn-orange-1:#ffc44d;
      --btn-orange-2:#ff9b2f;
      --btn-orange-3:#ff7a1a;

      --btn-green-1:#69f07a;
      --btn-green-2:#2edb69;
      --btn-green-3:#12b85a;

      --btn-red-1:#ff7a7a;
      --btn-red-2:#ff4f5b;
      --btn-red-3:#e83b45;

      --btn-blue-1:#7ad6ff;
      --btn-blue-2:#39b7ff;
      --btn-blue-3:#0e9ce6;

      --btn-ink:#2b2b2b;
      --btn-cream:#fff3d2;
    }

    .cart-btn{
      width: 100%;
      padding: 14px 16px;
      border-radius: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      color: #2a1b00;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      border: 2px solid rgba(0,0,0,.18);
      box-shadow:
        0 10px 0 rgba(0,0,0,.22),
        0 18px 28px rgba(0,0,0,.35);
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .cart-btn::before{
      content:"";
      position:absolute;
      inset: 3px 3px auto 3px;
      height: 46%;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
      pointer-events:none;
      opacity: .9;
    }
    .cart-btn:active{
      transform: translateY(6px);
      filter: brightness(.98) saturate(1.02);
      box-shadow:
        0 4px 0 rgba(0,0,0,.22),
        0 10px 18px rgba(0,0,0,.28);
    }
    .cart-btn .row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      position: relative;
      z-index: 1;
    }
    .badge{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: rgba(255,255,255,.25);
      border: 2px solid rgba(0,0,0,.14);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .btn-label{
      font-size: 18px;
      line-height: 1;
    }

    .btn-green{ background: linear-gradient(180deg, var(--btn-green-1), var(--btn-green-2) 55%, var(--btn-green-3)); }
    .btn-orange{ background: linear-gradient(180deg, var(--btn-orange-1), var(--btn-orange-2) 55%, var(--btn-orange-3)); }
    .btn-red{ background: linear-gradient(180deg, var(--btn-red-1), var(--btn-red-2) 55%, var(--btn-red-3)); }
    .btn-blue{ background: linear-gradient(180deg, var(--btn-blue-1), var(--btn-blue-2) 55%, var(--btn-blue-3)); }

    .icon-btn{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 2px solid rgba(0,0,0,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.12));
      box-shadow:
        0 8px 0 rgba(0,0,0,.22),
        0 16px 24px rgba(0,0,0,.32);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      overflow:hidden;
      position:relative;
    }
    .icon-btn::before{
      content:"";
      position:absolute;
      inset: 3px 3px auto 3px;
      height: 46%;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
      pointer-events:none;
      opacity: .9;
    }
    .icon-btn:active{
      transform: translateY(5px);
      box-shadow:
        0 3px 0 rgba(0,0,0,.22),
        0 10px 16px rgba(0,0,0,.26);
      filter: brightness(.99);
    }

    .svg{
      width: 22px;
      height: 22px;
      stroke: #1f1f1f;
      stroke-width: 2.6;
      fill: none;
      position:relative;
      z-index:1;
    }
    .svg-fill{
      fill:#1f1f1f;
      stroke:none;
    }

    /* UI ICON IMAGES (LOCAL) */
    .ui-icon{
      width: 22px;
      height: 22px;
      object-fit: contain;
      position: relative;
      z-index: 1;
      filter: drop-shadow(0 2px 0 rgba(255,255,255,.25));
    }
    .badge .ui-icon { width: 24px; height: 24px; }
    .icon-btn .ui-icon { width: 22px; height: 22px; }

    /* HOME title float */
    @keyframes homeFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .home-title-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom: 1.1rem;
      animation: homeFloat 3s ease-in-out infinite;
    }
    .home-title-img{
      width: min(340px, 84vw);
      height: auto;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      user-select:none;
      pointer-events:none;
    }

    /* HUD pills */
    .pill{
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow:
        0 8px 0 rgba(0,0,0,.20),
        0 16px 24px rgba(0,0,0,.30);
    }

    /* ANIMATIONS */
    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      20% { transform: translateX(-12px) rotate(-3deg); }
      40% { transform: translateX(12px) rotate(3deg); }
      60% { transform: translateX(-12px) rotate(-3deg); }
      80% { transform: translateX(12px) rotate(3deg); }
    }
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
      100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5), inset 0 0 20px rgba(34, 197, 94, 0.2); }
      50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8), inset 0 0 30px rgba(34, 197, 94, 0.3); }
    }
    @keyframes slide-up {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pop-in {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      70% { transform: scale(1.1); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes bounce-in {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    @keyframes toast-slide {
      from { transform: translateY(-120%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes timer-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* UTILITY CLASSES */
    .bin { transition: all 0.2s ease; position: relative; overflow: hidden; }
    .bin.highlight {
      transform: scale(1.08);
      box-shadow: 0 0 30px rgba(255,255,255,0.6), inset 0 0 18px rgba(255,255,255,0.22);
    }
    .bin.wrong { animation: shake 0.5s ease; }

    .trash-card {
      transition: all 0.15s ease;
      touch-action: none;
      cursor: grab;
      position: relative;
      overflow: hidden;
    }
    .trash-card:active { cursor: grabbing; }
    .trash-card.dragging {
      transform: scale(1.12) rotate(6deg);
      box-shadow: 0 25px 50px rgba(0,0,0,0.4);
      z-index: 1000;
      filter: brightness(1.05);
    }
    .trash-card.correct { animation: pop-in 0.5s ease forwards; }
    .sparkle { animation: sparkle 0.7s ease-out forwards; pointer-events: none; }
    .float { animation: float 2.5s ease-in-out infinite; }
    .pulse-glow { animation: pulse-glow 1.5s ease-in-out infinite; }
    .slide-up { animation: slide-up 0.3s ease forwards; }
    .pop-in { animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
    .bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
    .toast { animation: toast-slide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    .star { transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .star.earned {
      color: #fbbf24;
      text-shadow: 0 0 25px rgba(251, 191, 36, 0.9), 0 0 50px rgba(251, 191, 36, 0.6);
      animation: bounce-in 0.5s ease forwards;
    }
    .star.empty { color: #6b7280; opacity: 0.3; }

    .contamination-bar {
      transition: all 0.3s ease;
      background: linear-gradient(90deg, #f59e0b, #ef4444, #991b1b);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .level-node { transition: all 0.2s ease; border-radius: 16px; position: relative; overflow: hidden; }
    .level-node:not(.locked) { cursor: pointer; }
    .level-node:not(.locked):active { transform: translateY(5px); }
    .level-node.locked { filter: grayscale(1) brightness(0.5); opacity: 0.7; }
    .level-node::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .level-node:not(.locked):hover::before { opacity: 1; }

    .screen {
      display: none;
      height: 100%;
      width: 100%;
      flex-direction: column;
      overflow-y: auto;
      position: absolute;
      inset: 0;
    }
    .screen.active { display: flex; }

    .boost-btn { transition: transform .12s ease, filter .12s ease, box-shadow .12s ease; }
    .boost-btn:not(:disabled) { cursor: pointer; }
    .boost-btn:not(:disabled):active { transform: translateY(5px); filter: brightness(.98); }
    .boost-btn:disabled { opacity: 0.4; filter: grayscale(0.7); }

    .clean-overlay { animation: pulse 0.8s infinite; background: linear-gradient(135deg, rgba(202, 138, 4, 0.9), rgba(177, 98, 0, 0.9)); }
    .timer-critical { animation: timer-pulse 0.5s ease infinite; color: #fca5a5; font-weight: 900; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
  </style>
</head>

<body class="h-full w-full game-font overflow-hidden">
  <div id="app" class="h-full w-full relative flex flex-col">

    <!-- HOME SCREEN -->
    <div id="home-screen" class="screen active bg-home flex flex-col items-center justify-center p-6 text-center min-h-screen">

      <div class="home-title-wrap">
        <img src="background-ui/title.png" alt="EcoRush" class="home-title-img" />
      </div>

      <div class="space-y-4 w-full max-w-xs mb-10">
        <button onclick="showScreen('map-screen')" class="cart-btn btn-green" aria-label="Play" data-icon="play">
          <div class="row">
            <div class="badge">
              <!-- SVG fallback -->
              <svg class="svg svg-fill" viewBox="0 0 24 24"><path d="M8 5l12 7-12 7z"/></svg>
            </div>
            <span class="btn-label">Play</span>
          </div>
        </button>

        <button onclick="showScreen('shop-screen')" class="cart-btn btn-orange" aria-label="Shop" data-icon="shop">
          <div class="row">
            <div class="badge">
              <!-- SVG fallback -->
              <svg class="svg" viewBox="0 0 24 24">
                <path d="M6 7h15l-1.5 9H7.2L6 7z"/>
                <path d="M6 7l-2-3H2"/>
                <path d="M9 21a1 1 0 100-2 1 1 0 000 2z"/>
                <path d="M18 21a1 1 0 100-2 1 1 0 000 2z"/>
              </svg>
            </div>
            <span class="btn-label">Shop</span>
          </div>
        </button>
      </div>

      <!-- COINS & LIVES -->
      <div class="flex gap-4 text-center">
        <div class="pill flex items-center gap-3 px-6 py-3">
          <svg class="svg" viewBox="0 0 24 24">
            <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
            <path d="M8.5 12h7"></path>
            <path d="M12 8.5v7"></path>
          </svg>
          <span id="home-coins" class="text-2xl font-black text-white drop-shadow">0</span>
        </div>
        <div class="pill flex items-center gap-3 px-6 py-3">
          <svg class="svg svg-fill" viewBox="0 0 24 24">
            <path d="M12 21s-7-4.6-9.3-8.8C.9 8.6 3.1 6 6 6c1.7 0 3.1.9 4 2.1C10.9 6.9 12.3 6 14 6c2.9 0 5.1 2.6 3.3 6.2C19 16.4 12 21 12 21z"/>
          </svg>
          <span id="home-lives" class="text-2xl font-black text-white drop-shadow">5</span>
        </div>
      </div>
    </div>

    <!-- MAP SCREEN -->
    <div id="map-screen" class="screen bg-map flex-col p-4">
      <div class="flex items-center justify-between mb-4">
        <button onclick="showScreen('home-screen')" class="icon-btn" aria-label="Back" data-icon="back">
          <svg class="svg" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>

        <h2 class="text-xl font-black text-white drop-shadow">Select Level</h2>

        <button onclick="showScreen('shop-screen')" class="icon-btn" aria-label="Shop" data-icon="shop">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M6 7h15l-1.5 9H7.2L6 7z"/>
            <path d="M6 7l-2-3H2"/>
            <path d="M9 21a1 1 0 100-2 1 1 0 000 2z"/>
            <path d="M18 21a1 1 0 100-2 1 1 0 000 2z"/>
          </svg>
        </button>
      </div>

      <div class="pill flex items-center gap-2 px-4 py-2 mb-4 self-center">
        <svg class="svg" viewBox="0 0 24 24">
          <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
          <path d="M8.5 12h7"></path>
          <path d="M12 8.5v7"></path>
        </svg>
        <span id="map-coins" class="text-lg font-black text-white drop-shadow">0</span>
      </div>

      <div id="level-grid" class="flex-1 overflow-y-auto pb-4 space-y-6"></div>
    </div>

    <!-- SHOP SCREEN -->
    <div id="shop-screen" class="screen bg-shop flex-col p-4">
      <div class="flex items-center justify-between mb-4">
        <button onclick="showScreen('home-screen')" class="icon-btn" aria-label="Back" data-icon="back">
          <svg class="svg" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>

        <h2 class="text-xl font-black text-white drop-shadow">Shop</h2>
        <div class="w-12"></div>
      </div>

      <div class="pill flex items-center gap-2 px-4 py-2 mb-4 self-center">
        <svg class="svg" viewBox="0 0 24 24">
          <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
          <path d="M8.5 12h7"></path>
          <path d="M12 8.5v7"></path>
        </svg>
        <span id="shop-coins" class="text-lg font-black text-white drop-shadow">0</span>
      </div>

      <div class="flex-1 overflow-y-auto space-y-3 pb-4">
        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm border border-white/15">
          <h3 class="text-lg font-black text-white mb-3 drop-shadow">Your Inventory</h3>
          <div id="inventory-display" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm border border-white/15">
          <h3 class="text-lg font-black text-white mb-3 drop-shadow">Buy Boosts</h3>
          <div class="space-y-3">

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl border border-white/10">
              <div class="flex items-center gap-3">
                <div class="badge" style="background: rgba(255,255,255,.18);">
                  <svg class="svg" viewBox="0 0 24 24">
                    <path d="M9 18h6"/>
                    <path d="M10 22h4"/>
                    <path d="M12 2a7 7 0 00-4 12c.7.6 1 1.3 1 2h6c0-.7.3-1.4 1-2a7 7 0 00-4-12z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-black text-white">Hint</p>
                  <p class="text-xs text-emerald-200">Shows correct bin</p>
                </div>
              </div>
              <button onclick="buyBoost('hint')" class="cart-btn btn-orange" style="width:auto; padding:10px 12px; border-radius:14px;">
                <div class="row" style="gap:8px;">
                  <span class="btn-label" style="font-size:14px;">50</span>
                  <svg class="svg" viewBox="0 0 24 24" style="width:18px;height:18px;">
                    <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
                    <path d="M8.5 12h7"></path>
                    <path d="M12 8.5v7"></path>
                  </svg>
                </div>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl border border-white/10">
              <div class="flex items-center gap-3">
                <div class="badge" style="background: rgba(255,255,255,.18);">
                  <svg class="svg" viewBox="0 0 24 24">
                    <path d="M12 2l8 4v6c0 5-3.4 9.4-8 10-4.6-.6-8-5-8-10V6l8-4z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-black text-white">Shield</p>
                  <p class="text-xs text-emerald-200">Blocks next penalty</p>
                </div>
              </div>
              <button onclick="buyBoost('shield')" class="cart-btn btn-orange" style="width:auto; padding:10px 12px; border-radius:14px;">
                <div class="row" style="gap:8px;">
                  <span class="btn-label" style="font-size:14px;">80</span>
                  <svg class="svg" viewBox="0 0 24 24" style="width:18px;height:18px;">
                    <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
                    <path d="M8.5 12h7"></path>
                    <path d="M12 8.5v7"></path>
                  </svg>
                </div>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl border border-white/10">
              <div class="flex items-center gap-3">
                <div class="badge" style="background: rgba(255,255,255,.18);">
                  <svg class="svg" viewBox="0 0 24 24">
                    <path d="M3 12h10"/>
                    <path d="M13 12l-3-3"/>
                    <path d="M13 12l-3 3"/>
                    <path d="M14 4h7v16h-7z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-black text-white">Vacuum</p>
                  <p class="text-xs text-emerald-200">Auto-sorts 1 item</p>
                </div>
              </div>
              <button onclick="buyBoost('vacuum')" class="cart-btn btn-orange" style="width:auto; padding:10px 12px; border-radius:14px;">
                <div class="row" style="gap:8px;">
                  <span class="btn-label" style="font-size:14px;">120</span>
                  <svg class="svg" viewBox="0 0 24 24" style="width:18px;height:18px;">
                    <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
                    <path d="M8.5 12h7"></path>
                    <path d="M12 8.5v7"></path>
                  </svg>
                </div>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl border border-white/10">
              <div class="flex items-center gap-3">
                <div class="badge" style="background: rgba(255,255,255,.18);">
                  <svg class="svg" viewBox="0 0 24 24">
                    <path d="M12 2v20"/>
                    <path d="M5 7h14"/>
                    <path d="M7 12h10"/>
                    <path d="M9 17h6"/>
                  </svg>
                </div>
                <div>
                  <p class="font-black text-white">Freeze</p>
                  <p class="text-xs text-emerald-200">Stops timer 5s</p>
                </div>
              </div>
              <button onclick="buyBoost('freeze')" class="cart-btn btn-orange" style="width:auto; padding:10px 12px; border-radius:14px;">
                <div class="row" style="gap:8px;">
                  <span class="btn-label" style="font-size:14px;">100</span>
                  <svg class="svg" viewBox="0 0 24 24" style="width:18px;height:18px;">
                    <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
                    <path d="M8.5 12h7"></path>
                    <path d="M12 8.5v7"></path>
                  </svg>
                </div>
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen flex-col">

      <!-- Top HUD -->
      <div class="bg-black/30 p-3 flex items-center justify-between backdrop-blur-sm">
        <button onclick="pauseGame()" class="icon-btn" aria-label="Pause" data-icon="pause">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M7 5v14"></path>
            <path d="M17 5v14"></path>
          </svg>
        </button>

        <div class="flex items-center gap-4">
          <div class="pill flex items-center gap-2 px-3 py-2">
            <svg class="svg svg-fill" viewBox="0 0 24 24">
              <path d="M12 2l2.7 6.7 7.3.6-5.6 4.6 1.8 7.1-6.2-3.8-6.2 3.8 1.8-7.1L2 9.3l7.3-.6L12 2z"/>
            </svg>
            <span id="game-score" class="font-black text-white">0</span>
          </div>

          <div id="timer-display" class="pill flex items-center gap-2 px-3 py-2 hidden">
            <svg class="svg" viewBox="0 0 24 24">
              <path d="M12 7v6l3 2"></path>
              <path d="M9 2h6"></path>
              <path d="M12 22a9 9 0 100-18 9 9 0 000 18z"></path>
            </svg>
            <span id="game-timer" class="font-black text-white">60</span>
          </div>
        </div>

        <div class="pill flex items-center gap-2 px-3 py-2">
          <svg class="svg" viewBox="0 0 24 24">
            <ellipse cx="12" cy="12" rx="8" ry="8"></ellipse>
            <path d="M8.5 12h7"></path>
            <path d="M12 8.5v7"></path>
          </svg>
          <span id="game-coins" class="text-sm font-black text-white">0</span>
        </div>
      </div>

      <!-- Streak & Wave Info -->
      <div class="flex justify-between items-center px-3 py-2 bg-black/20">
        <div class="pill flex items-center gap-2 px-3 py-2">
          <span class="text-xs text-white/90">Level</span>
          <span id="level-display" class="font-black text-white">1</span>
        </div>

        <div id="streak-display" class="pill flex items-center gap-2 px-3 py-2 hidden">
          <svg class="svg svg-fill" viewBox="0 0 24 24">
            <path d="M13 2s2 3 2 6-2 5-2 5 1-3-2-5-1-6-1-6 0 3-3 6c-3 3-2 8 2 11 1 .7 2 .9 3 1 6 0 10-6 7-12-2-4-6-6-6-6z"/>
          </svg>
          <span id="streak-count" class="text-sm font-black text-white">x1</span>
        </div>

        <div class="pill flex items-center gap-2 px-3 py-2">
          <span class="text-xs text-white/90">Wave</span>
          <span id="wave-display" class="font-black text-white">1/1</span>
        </div>
      </div>

      <!-- Contamination Bar -->
      <div class="px-3 py-2 bg-black/20">
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs text-white/90">Contamination</span>
          <span id="contamination-percent" class="text-xs text-red-200 font-black">0%</span>
        </div>
        <div class="h-3 bg-gray-700 rounded-full overflow-hidden border border-white/10">
          <div id="contamination-bar" class="h-full contamination-bar" style="width: 0%"></div>
        </div>
      </div>

      <!-- Boosts Bar -->
      <div class="flex justify-center gap-2 px-3 py-2 bg-black/10">
        <button id="boost-hint" onclick="useBoost('hint')" class="icon-btn boost-btn" disabled aria-label="Hint" data-icon="hint">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M9 18h6"/>
            <path d="M10 22h4"/>
            <path d="M12 2a7 7 0 00-4 12c.7.6 1 1.3 1 2h6c0-.7.3-1.4 1-2a7 7 0 00-4-12z"/>
          </svg>
          <span class="absolute bottom-1 right-1 text-[11px] font-black text-white/95" id="hint-count">0</span>
        </button>

        <button id="boost-shield" onclick="useBoost('shield')" class="icon-btn boost-btn" disabled aria-label="Shield" data-icon="shield">
          <svg class="svg" viewBox="0 0 24 24"><path d="M12 2l8 4v6c0 5-3.4 9.4-8 10-4.6-.6-8-5-8-10V6l8-4z"/></svg>
          <span class="absolute bottom-1 right-1 text-[11px] font-black text-white/95" id="shield-count">0</span>
        </button>

        <button id="boost-vacuum" onclick="useBoost('vacuum')" class="icon-btn boost-btn" disabled aria-label="Vacuum" data-icon="vacuum">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M3 12h10"/>
            <path d="M13 12l-3-3"/>
            <path d="M13 12l-3 3"/>
            <path d="M14 4h7v16h-7z"/>
          </svg>
          <span class="absolute bottom-1 right-1 text-[11px] font-black text-white/95" id="vacuum-count">0</span>
        </button>

        <button id="boost-freeze" onclick="useBoost('freeze')" class="icon-btn boost-btn" disabled aria-label="Freeze" data-icon="freeze">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M12 2v20"/>
            <path d="M5 7h14"/>
            <path d="M7 12h10"/>
            <path d="M9 17h6"/>
          </svg>
          <span class="absolute bottom-1 right-1 text-[11px] font-black text-white/95" id="freeze-count">0</span>
        </button>

        <div id="shield-active" class="hidden items-center px-3 py-2 pill"><span class="text-xs font-black text-white">Shield</span></div>
      </div>

      <!-- Bins + Tray -->
      <div class="flex-1 flex flex-col justify-between p-3 min-h-0">
        <div id="bins-container" class="grid grid-cols-4 gap-2 mb-3">
          <div class="bin flex flex-col items-center p-2 rounded-2xl shadow-lg bg-green-600/85 border border-white/10" data-bin="biodegradable">
            <svg class="svg" viewBox="0 0 24 24" style="stroke:white;">
              <path d="M20 4s-6 0-10 4-4 10-4 10 6 0 10-4 4-10 4-10z"/>
              <path d="M10 14c3-1 6-4 7-7"/>
            </svg>
            <span class="text-xs text-white font-black text-center leading-tight mt-1">Bio</span>
          </div>

          <div class="bin flex flex-col items-center p-2 rounded-2xl shadow-lg bg-blue-600/85 border border-white/10" data-bin="recyclable">
            <svg class="svg" viewBox="0 0 24 24" style="stroke:white;">
              <path d="M7 7l2-4 4 2"/>
              <path d="M9 3l-2 4 3 3"/>
              <path d="M17 7l-2-4-4 2"/>
              <path d="M15 3l2 4-3 3"/>
              <path d="M6 16l-4-1 2-4"/>
              <path d="M2 15l4 1 3-3"/>
              <path d="M18 16l4-1-2-4"/>
              <path d="M22 15l-4 1-3-3"/>
            </svg>
            <span class="text-xs text-white font-black text-center leading-tight mt-1">Recycle</span>
          </div>

          <div class="bin flex flex-col items-center p-2 rounded-2xl shadow-lg bg-gray-600/85 border border-white/10" data-bin="residual">
            <svg class="svg" viewBox="0 0 24 24" style="stroke:white;">
              <path d="M4 7h16"/>
              <path d="M7 7l1 14h8l1-14"/>
              <path d="M9 7V4h6v3"/>
            </svg>
            <span class="text-xs text-white font-black text-center leading-tight mt-1">Residual</span>
          </div>

          <div class="bin flex flex-col items-center p-2 rounded-2xl shadow-lg bg-red-600/85 border border-white/10" data-bin="hazardous">
            <svg class="svg" viewBox="0 0 24 24" style="stroke:white;">
              <path d="M12 2l10 18H2L12 2z"/>
              <path d="M12 9v4"/>
              <path d="M12 17h.01"/>
            </svg>
            <span class="text-xs text-white font-black text-center leading-tight mt-1">Hazard</span>
          </div>
        </div>

        <div id="trash-tray" class="flex-1 bg-black/20 rounded-2xl p-3 overflow-hidden flex flex-wrap content-start gap-2 justify-center border border-white/10"></div>
      </div>
    </div>

    <!-- PAUSE MODAL -->
    <div id="pause-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6 z-50">
      <div class="bg-gradient-to-br from-emerald-700 to-teal-800 rounded-3xl p-6 w-full max-w-sm text-center pop-in border border-white/10">
        <h2 class="text-2xl font-black text-white mb-6 drop-shadow">Paused</h2>
        <div class="space-y-3">
          <button onclick="resumeGame()" class="cart-btn btn-green">Resume</button>
          <button onclick="restartLevel()" class="cart-btn btn-orange">Restart</button>
          <button onclick="quitToMap()" class="cart-btn btn-red">Quit</button>
        </div>
      </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6 z-50">
      <div class="bg-gradient-to-br from-emerald-700 to-teal-800 rounded-3xl p-6 w-full max-w-sm text-center pop-in border border-white/10">
        <div id="result-emoji" class="text-6xl mb-4">üéâ</div>
        <h2 id="result-title" class="text-2xl font-black text-white mb-2 drop-shadow">Level Complete!</h2>
        <p id="result-message" class="text-emerald-200 mb-4">Great job!</p>

        <div id="result-stars" class="flex justify-center gap-2 mb-4 text-4xl">
          <span class="star empty">‚≠ê</span>
          <span class="star empty">‚≠ê</span>
          <span class="star empty">‚≠ê</span>
        </div>

        <div class="flex justify-center gap-4 mb-6">
          <div class="pill px-4 py-2 rounded-xl">
            <p class="text-xs text-white/80 font-black">Score</p>
            <p id="result-score" class="text-xl font-black text-white">0</p>
          </div>
          <div class="pill px-4 py-2 rounded-xl">
            <p class="text-xs text-white/80 font-black">Coins</p>
            <p id="result-coins" class="text-xl font-black text-white">+0</p>
          </div>
        </div>

        <div class="space-y-3">
          <button id="next-level-btn" onclick="nextLevel()" class="cart-btn btn-green">Next Level</button>
          <button onclick="restartLevel()" class="cart-btn btn-orange">Retry</button>
          <button onclick="quitToMap()" class="cart-btn btn-blue" style="color:#0b1c2a;">Map</button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-full hidden z-50">
      <span id="toast-text">Message</span>
    </div>

    <!-- Sparkle Container -->
    <div id="sparkles" class="fixed inset-0 pointer-events-none z-40"></div>
  </div>

  <script>
    // =========================================================
    // üîä LOW-LATENCY SFX (STACKABLE) + üéµ BGM (ALWAYS ON)
    // Put audio files in: /sounds/
    // Put UI icons in: /ui-icons/ (e.g. play.png, shop.png, back.png, pause.png)
    // =========================================================
    const SFX = {
      click:   "sounds/click.mp3",
      correct: "sounds/correct.mp3",
      wrong:   "sounds/wrong.mp3",
      clean:   "sounds/clean.mp3",
      win:     "sounds/win.mp3",
      lose:    "sounds/lose.mp3",
      buy:     "sounds/buy.mp3"
    };

    const BGM_SRC = "sounds/bgm.mp3"; // required
    let sfxEnabled = true;

    // ---- WebAudio (fast + overlapping) ----
    let audioUnlocked = false;
    let audioCtx = null;
    let masterGain = null;
    const sfxBuffers = {}; // name -> AudioBuffer

    // ---- BGM (<audio>, loop) ----
    let bgmAudio = null;

    function initBgm() {
      if (bgmAudio) return;
      bgmAudio = new Audio(BGM_SRC);
      bgmAudio.loop = true;
      bgmAudio.preload = "auto";
      bgmAudio.volume = 0.35;
    }

    function playBgm() {
      initBgm();
      if (!bgmAudio) return;
      if (!bgmAudio.paused) return;
      bgmAudio.play().catch(() => {});
    }

    async function initWebAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.9;
      masterGain.connect(audioCtx.destination);

      // Preload + decode all SFX into RAM
      const entries = Object.entries(SFX);
      await Promise.all(entries.map(async ([name, url]) => {
        try {
          const res = await fetch(url, { cache: "force-cache" });
          const arr = await res.arrayBuffer();
          const buf = await audioCtx.decodeAudioData(arr);
          sfxBuffers[name] = buf;
        } catch (e) {
          console.warn("SFX load failed:", name, url);
        }
      }));
    }

    function playSfx(name, vol = 0.85) {
      if (!sfxEnabled) return;

      // WebAudio path (instant, stackable)
      if (audioCtx && sfxBuffers[name]) {
        try {
          const src = audioCtx.createBufferSource();
          src.buffer = sfxBuffers[name];

          const g = audioCtx.createGain();
          g.gain.value = Math.max(0, Math.min(1, vol));

          src.connect(g);
          g.connect(masterGain);

          src.start(0);
        } catch (e) {}
        return;
      }

      // Fallback path (rare)
      try {
        const a = new Audio(SFX[name]);
        a.preload = "auto";
        a.volume = vol;
        a.play().catch(() => {});
      } catch (e) {}
    }

    async function unlockAudioOnce() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      // Resume/initialize WebAudio
      try {
        await initWebAudio();
        if (audioCtx.state === "suspended") await audioCtx.resume();

        // tiny silent ping
        const buf = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
        const src = audioCtx.createBufferSource();
        src.buffer = buf;
        src.connect(masterGain);
        src.start(0);
      } catch (e) {}

      // Start BGM after unlock (always on)
      initBgm();
      if (bgmAudio) bgmAudio.play().catch(() => {});
    }

    // One-time user gesture unlock
    window.addEventListener("pointerdown", unlockAudioOnce, { once: true });
    window.addEventListener("touchstart", unlockAudioOnce, { once: true, passive: true });

    // Click sound for ANY button + keep retrying BGM start
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (btn && !btn.disabled) playSfx("click", 0.75);
      playBgm();
    });

    // Try early (won't actually play until gesture)
    initBgm();
    playBgm();

    // =========================================================
    // ‚úÖ TRASH ICONS (LOCAL) + FALLBACK
    // =========================================================
    const TRASH_ICON_FOLDER = "trash-icons";

    function slugify(name) {
      return name
        .toLowerCase()
        .trim()
        .replace(/['"]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function getTrashIconSrc(item) {
      return `${TRASH_ICON_FOLDER}/${slugify(item.name)}.png`;
    }

    function getEmojiImageSrc(emoji) {
      const codePoints = Array.from(emoji)
        .map(char => char.codePointAt(0).toString(16))
        .filter(code => code !== "fe0f");
      return `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/${codePoints.join("-")}.png`;
    }

    function getDifficultyName(level){
      if (level <= 5) return "easy";
      if (level <= 15) return "normal";
      if (level <= 25) return "hard";
      return "extreme";
    }

    function applyGameBackground(level){
      const gameScreen = document.getElementById("game-screen");
      gameScreen.classList.remove("bg-game-easy","bg-game-normal","bg-game-hard","bg-game-extreme");
      gameScreen.classList.add(`bg-game-${getDifficultyName(level)}`);
    }

    // =========================================================
    // üñºÔ∏è UI ICONS (LOCAL) ‚Äî Put images in: ui-icons/
    // Example files:
    // ui-icons/play.png, ui-icons/shop.png, ui-icons/back.png, ui-icons/pause.png
    // ui-icons/hint.png, ui-icons/shield.png, ui-icons/vacuum.png, ui-icons/freeze.png
    // =========================================================
    const UI_ICON_FOLDER = "ui-icons";

    function getUiIconSrc(name) {
      return `${UI_ICON_FOLDER}/${slugify(name)}.png`;
    }

    function setButtonIcon(btn, iconName, altText = "") {
      if (!btn) return;

      const svg = btn.querySelector("svg");
      const existingImg = btn.querySelector("img.ui-icon");

      const img = document.createElement("img");
      img.className = "ui-icon";
      img.alt = altText || iconName;
      img.loading = "lazy";
      img.src = getUiIconSrc(iconName);

      img.onerror = () => {
        img.remove();
        if (svg) svg.style.display = "";
      };

      img.onload = () => {
        if (svg) svg.style.display = "none";
      };

      if (existingImg) existingImg.remove();

      const badge = btn.querySelector(".badge");
      if (badge) badge.appendChild(img);
      else btn.appendChild(img);
    }

    function applyAllUiIcons() {
      document.querySelectorAll("button[data-icon]").forEach(btn => {
        const icon = btn.getAttribute("data-icon");
        setButtonIcon(btn, icon, icon);
      });
    }

    // ========== TRASH DATABASE ==========
    const TRASH_DATABASE = {
      biodegradable: [
        { name: "Banana Peel", emoji: "üçå" },
        { name: "Leftover Rice", emoji: "üçö" },
        { name: "Fish Bones", emoji: "üêü" },
        { name: "Chicken Bones", emoji: "üçó" },
        { name: "Mango Seed", emoji: "ü•≠" },
        { name: "Coconut Husk", emoji: "ü••" },
        { name: "Vegetable Peels", emoji: "ü•ï" },
        { name: "Corn Cob", emoji: "üåΩ" },
        { name: "Egg Shells", emoji: "ü•ö" },
        { name: "Calamansi Peel", emoji: "üçã" },
        { name: "Used Tea Leaves", emoji: "üçµ" },
        { name: "Coffee Grounds", emoji: "‚òï" },
        { name: "Wilted Leaves", emoji: "üçÇ" },
        { name: "Bread Leftover", emoji: "üçû" },
        { name: "Fruit Peels", emoji: "üçä" },
        { name: "Pineapple Crown", emoji: "üçç" },
        { name: "Watermelon Rind", emoji: "üçâ" },
        { name: "Peanut Shells", emoji: "ü•ú" }
      ],
      recyclable: [
        { name: "Water Bottle", emoji: "üß¥" },
        { name: "Soft Drink Bottle", emoji: "üçæ" },
        { name: "Sardines Can", emoji: "ü•´" },
        { name: "Tuna Can", emoji: "ü•´" },
        { name: "Glass Bottle", emoji: "üç∂" },
        { name: "Aluminum Can", emoji: "ü•§" },
        { name: "Shopee Box", emoji: "üì¶" },
        { name: "Lazada Box", emoji: "üì¶" },
        { name: "Newspaper", emoji: "üì∞" },
        { name: "Cardboard", emoji: "üìã" },
        { name: "Paper Bag", emoji: "üõçÔ∏è" },
        { name: "Clean Plastic Container", emoji: "ü´ô" },
        { name: "Detergent Bottle", emoji: "üß¥", needsCleaning: true },
        { name: "Glass Jar", emoji: "ü´ô" },
        { name: "Metal Lid", emoji: "‚≠ï" },
        { name: "Milk Carton", emoji: "ü•õ", needsCleaning: true },
        { name: "Magazine", emoji: "üìñ" },
        { name: "Office Paper", emoji: "üìÑ" }
      ],
      residual: [
        { name: "Used Diaper", emoji: "üë∂" },
        { name: "Candy Wrapper", emoji: "üç¨" },
        { name: "Chip Bag", emoji: "ü•î" },
        { name: "Styrofoam Plate", emoji: "üçΩÔ∏è" },
        { name: "Plastic Straw", emoji: "ü•§" },
        { name: "Dirty Plastic Bag", emoji: "üõçÔ∏è" },
        { name: "Broken Tsinelas", emoji: "ü©¥" },
        { name: "Old Sponge", emoji: "üßΩ" },
        { name: "Used Tissue", emoji: "üßª" },
        { name: "Old Toothbrush", emoji: "ü™•" },
        { name: "Broken Ceramic", emoji: "üè∫" },
        { name: "Sachet Wrapper", emoji: "üì¶" },
        { name: "Used Face Mask", emoji: "üò∑" },
        { name: "Wet Wipes", emoji: "üß¥" },
        { name: "Used Tape", emoji: "üìé" },
        { name: "Dirty Paper Cup", emoji: "ü•§" },
        { name: "Cigarette Butt", emoji: "üö¨" },
        { name: "Rubber Band", emoji: "‚≠ï" }
      ],
      hazardous: [
        { name: "AA Battery", emoji: "üîã" },
        { name: "Phone Battery", emoji: "üì±" },
        { name: "Light Bulb", emoji: "üí°" },
        { name: "Mosquito Spray", emoji: "ü¶ü" },
        { name: "Bleach Bottle", emoji: "üß¥" },
        { name: "Pesticide Bottle", emoji: "‚ò†Ô∏è" },
        { name: "Medicine Blister", emoji: "üíä" },
        { name: "Expired Medicine", emoji: "üíä" },
        { name: "Nail Polish", emoji: "üíÖ" },
        { name: "Aerosol Can", emoji: "üß¥" },
        { name: "Old Charger", emoji: "üîå" },
        { name: "Broken Thermometer", emoji: "üå°Ô∏è" },
        { name: "Ink Cartridge", emoji: "üñ®Ô∏è" },
        { name: "Paint Can", emoji: "üé®" },
        { name: "Motor Oil", emoji: "üõ¢Ô∏è" },
        { name: "Fluorescent Tube", emoji: "üí°" },
        { name: "Car Battery", emoji: "üöó" },
        { name: "Broken Phone", emoji: "üì±" }
      ]
    };

    const DECOY_ITEMS = [
      { name: "Dirty Water Bottle", emoji: "üß¥", category: "residual", looksLike: "recyclable" },
      { name: "Clean Paper Cup", emoji: "ü•§", category: "recyclable", looksLike: "residual", needsCleaning: true },
      { name: "Greasy Pizza Box", emoji: "üì¶", category: "residual", looksLike: "recyclable" },
      { name: "Clean Styrofoam", emoji: "üì¶", category: "residual", looksLike: "recyclable" }
    ];

    function getLevelConfig(level) {
      let trashCount = 5 + Math.floor(level * 0.8);
      let hazardChance = Math.min(0.1 + level * 0.01, 0.4);
      let contaminationPenalty = 10 + Math.floor(level * 0.5);
      let timer = 0;
      let timerType = 'none';
      let waves = 1;
      let useDecoys = level >= 6;

      if (level >= 7 && level <= 9) {
        timer = 60 + (level - 7) * 10;
        timerType = 'soft';
      } else if (level >= 10) {
        timer = Math.max(40, 90 - (level - 10) * 2);
        timerType = 'hard';
      }

      if (level >= 8 && level <= 15) waves = 2;
      else if (level >= 16) waves = 3;

      const trashPerWave = Math.ceil(trashCount / waves);

      return {
        level,
        trashPerWave,
        totalTrash: trashPerWave * waves,
        hazardChance,
        contaminationPenalty,
        timer,
        timerType,
        waves,
        useDecoys
      };
    }

    let gameState = {
      coins: 0,
      levelStars: {},
      highestUnlocked: 1,
      boosts: { hint: 0, shield: 0, vacuum: 0, freeze: 0 }
    };

    let currentGame = {
      level: 1,
      config: null,
      score: 0,
      streak: 0,
      contamination: 0,
      currentWave: 1,
      trashItems: [],
      timer: 0,
      timerInterval: null,
      isPaused: false,
      isFreezed: false,
      shieldActive: false,
      coinsEarned: 0
    };

    function saveGame() {
      localStorage.setItem('ecoRushSave', JSON.stringify(gameState));
    }

    function loadGame() {
      const saved = localStorage.getItem('ecoRushSave');
      if (saved) {
        const parsed = JSON.parse(saved);
        gameState = { ...gameState, ...parsed };
      }
      updateAllCoinDisplays();
    }

    // ‚úÖ guarantee ONLY the target screen is visible
    function showScreen(screenId) {
      const screens = document.querySelectorAll('.screen');
      screens.forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none';
      });

      const target = document.getElementById(screenId);
      target.classList.add('active');
      target.style.display = 'flex';

      if (screenId === 'map-screen') renderLevelMap();
      else if (screenId === 'shop-screen') renderShop();

      updateAllCoinDisplays();

      // ‚úÖ BGM should play EVERYTIME (still needs user gesture first)
      playBgm();
    }

    function updateAllCoinDisplays() {
      document.getElementById('home-coins').textContent = gameState.coins;
      document.getElementById('map-coins').textContent = gameState.coins;
      document.getElementById('shop-coins').textContent = gameState.coins;
      document.getElementById('game-coins').textContent = gameState.coins;
    }

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-text').textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('toast');

      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('toast');
      }, duration);
    }

    function createSparkle(x, y, color = '#22c55e') {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle absolute';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      sparkle.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40">
        <path d="M20 0 L23 17 L40 20 L23 23 L20 40 L17 23 L0 20 L17 17 Z" fill="${color}"/>
      </svg>`;
      document.getElementById('sparkles').appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 600);
    }

    function renderLevelMap() {
      const grid = document.getElementById('level-grid');
      grid.innerHTML = '';

      const difficulties = [
        { name: 'Easy', range: [1, 5], color: 'from-green-500 to-emerald-600' },
        { name: 'Normal', range: [6, 15], color: 'from-yellow-500 to-amber-600' },
        { name: 'Hard', range: [16, 25], color: 'from-red-500 to-orange-600' },
        { name: 'Extreme', range: [26, 30], color: 'from-purple-600 to-pink-600' }
      ];

      difficulties.forEach(difficulty => {
        const section = document.createElement('div');
        section.className = 'px-4';

        const title = document.createElement('h3');
        title.className = 'text-lg font-black text-white mb-3 ml-2 drop-shadow';
        title.textContent = difficulty.name;
        section.appendChild(title);

        const levelGrid = document.createElement('div');
        levelGrid.className = 'grid grid-cols-5 gap-2';

        for (let i = difficulty.range[0]; i <= difficulty.range[1]; i++) {
          const stars = gameState.levelStars[i] || 0;
          const isUnlocked = i <= gameState.highestUnlocked;

          const node = document.createElement('button');
          node.className = `level-node aspect-square rounded-xl flex flex-col items-center justify-center text-sm ${
            isUnlocked ? `bg-gradient-to-br ${difficulty.color} border border-white/10` : 'bg-gray-600 locked'
          }`;
          node.style.boxShadow = isUnlocked ? '0 10px 0 rgba(0,0,0,.22), 0 18px 24px rgba(0,0,0,.32)' : '';

          if (isUnlocked) node.onclick = () => startLevel(i);

          node.innerHTML = `
            <span class="font-black text-white drop-shadow">${i}</span>
            <div class="flex gap-0.5 mt-0.5">
              ${[1, 2, 3].map(s => `<span class="text-xs ${s <= stars ? 'text-amber-300' : 'text-gray-400'}">‚≠ê</span>`).join('')}
            </div>
          `;

          levelGrid.appendChild(node);
        }

        section.appendChild(levelGrid);
        grid.appendChild(section);
      });
    }

    function renderShop() {
      const inventory = document.getElementById('inventory-display');
      inventory.innerHTML = `
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2 border border-white/10"><span class="text-white font-black">Hint</span><span class="text-white font-black ml-auto">${gameState.boosts.hint}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2 border border-white/10"><span class="text-white font-black">Shield</span><span class="text-white font-black ml-auto">${gameState.boosts.shield}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2 border border-white/10"><span class="text-white font-black">Vacuum</span><span class="text-white font-black ml-auto">${gameState.boosts.vacuum}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2 border border-white/10"><span class="text-white font-black">Freeze</span><span class="text-white font-black ml-auto">${gameState.boosts.freeze}</span></div>
      `;
    }

    function buyBoost(type) {
      const costs = { hint: 50, shield: 80, vacuum: 120, freeze: 100 };
      const cost = costs[type];

      if (gameState.coins >= cost) {
        gameState.coins -= cost;
        gameState.boosts[type]++;
        saveGame();
        updateAllCoinDisplays();
        renderShop();
        playSfx("buy", 0.8);
        showToast(`Purchased ${type}!`);
      } else {
        showToast(`Not enough coins! Need ${cost}`);
      }
    }

    function startLevel(level) {
      currentGame = {
        level,
        config: getLevelConfig(level),
        score: 0,
        streak: 0,
        contamination: 0,
        currentWave: 1,
        trashItems: [],
        timer: 0,
        timerInterval: null,
        isPaused: false,
        isFreezed: false,
        shieldActive: false,
        coinsEarned: 0
      };

      showScreen('game-screen');
      applyGameBackground(level);

      updateGameUI();
      updateBoostButtons();
      spawnWave();

      if (currentGame.config.timerType !== 'none') {
        currentGame.timer = currentGame.config.timer;
        document.getElementById('timer-display').classList.remove('hidden');
        document.getElementById('game-timer').textContent = currentGame.timer;
        startTimer();
      } else {
        document.getElementById('timer-display').classList.add('hidden');
      }

      playBgm();
    }

    function startTimer() {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      currentGame.timerInterval = setInterval(() => {
        if (currentGame.isPaused || currentGame.isFreezed) return;

        currentGame.timer--;
        const timerEl = document.getElementById('game-timer');
        timerEl.textContent = currentGame.timer;

        if (currentGame.timer <= 5 && currentGame.config.timerType !== 'none') {
          timerEl.classList.add('timer-critical');
        } else {
          timerEl.classList.remove('timer-critical');
        }

        if (currentGame.timer <= 0 && currentGame.config.timerType === 'hard') {
          endGame(false, 'Time ran out!');
        }
      }, 1000);
    }

    function spawnWave() {
      const tray = document.getElementById('trash-tray');
      tray.innerHTML = '';
      currentGame.trashItems = [];

      const config = currentGame.config;
      const items = [];

      for (let i = 0; i < config.trashPerWave; i++) {
        let item;

        if (Math.random() < config.hazardChance) {
          item = getRandomItem('hazardous');
        } else if (config.useDecoys && Math.random() < 0.15) {
          item = { ...DECOY_ITEMS[Math.floor(Math.random() * DECOY_ITEMS.length)] };
        } else {
          const categories = ['biodegradable', 'recyclable', 'residual'];
          const cat = categories[Math.floor(Math.random() * categories.length)];
          item = getRandomItem(cat);
        }

        items.push({
          ...item,
          id: `trash-${Date.now()}-${i}`,
          isCleaned: !item.needsCleaning
        });
      }

      currentGame.trashItems = items;

      items.forEach((item, idx) => {
        setTimeout(() => {
          const card = createTrashCard(item);
          tray.appendChild(card);
        }, idx * 90);
      });

      updateGameUI();
    }

    function getRandomItem(category) {
      const items = TRASH_DATABASE[category];
      const item = { ...items[Math.floor(Math.random() * items.length)], category };
      return item;
    }

    // =========================================================
    // ‚úÖ DRAG SYSTEM (global) ‚Äî avoids listener duplication
    // =========================================================
    let dragState = null;

    function onGlobalPointerMove(e){
      if (!dragState) return;

      const x = e.clientX;
      const y = e.clientY;

      dragState.card.style.left = (x - dragState.offsetX) + "px";
      dragState.card.style.top  = (y - dragState.offsetY) + "px";

      document.querySelectorAll('.bin').forEach(bin => {
        const r = bin.getBoundingClientRect();
        if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) bin.classList.add('highlight');
        else bin.classList.remove('highlight');
      });
    }

    function onGlobalPointerUp(e){
      if (!dragState) return;

      const x = e.clientX;
      const y = e.clientY;

      let droppedBin = null;
      document.querySelectorAll('.bin').forEach(bin => {
        bin.classList.remove('highlight');
        const r = bin.getBoundingClientRect();
        if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) droppedBin = bin;
      });

      const { item, card, originalParent } = dragState;

      card.classList.remove("dragging");

      if (droppedBin) {
        const binCategory = droppedBin.dataset.bin;
        handleDrop(item, binCategory, card, droppedBin);
      } else {
        returnCardToTray(card, originalParent);
      }

      dragState = null;
    }

    window.addEventListener("pointermove", onGlobalPointerMove, { passive: false });
    window.addEventListener("pointerup", onGlobalPointerUp, { passive: false });

    function createTrashCard(item) {
      const card = document.createElement('div');
      card.className = 'trash-card bg-white rounded-xl p-2 shadow-lg flex flex-col items-center pop-in';
      card.style.width = '74px';
      card.dataset.id = item.id;
      card.dataset.category = item.category;

      const needsClean = item.needsCleaning && !item.isCleaned;

      const imgDiv = document.createElement('div');
      imgDiv.className = 'relative w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg mb-1 overflow-hidden border border-black/10';

      const img = document.createElement('img');
      img.src = getTrashIconSrc(item);
      img.alt = item.name;
      img.className = 'w-10 h-10 object-contain';
      img.loading = 'lazy';

      img.onerror = function () {
        this.onerror = null;
        this.src = getEmojiImageSrc(item.emoji);
        this.onerror = function () {
          this.style.display = 'none';
          const fallback = document.createElement('span');
          fallback.textContent = item.emoji;
          fallback.className = 'text-3xl';
          imgDiv.appendChild(fallback);
        };
      };

      imgDiv.appendChild(img);

      if (needsClean) {
        const overlay = document.createElement('div');
        overlay.className = 'clean-overlay absolute inset-0 rounded-lg flex items-center justify-center';
        overlay.innerHTML = '<span class="text-white text-xs font-black">TAP</span>';
        imgDiv.appendChild(overlay);
      }

      card.appendChild(imgDiv);

      const name = document.createElement('span');
      name.className = 'text-[10px] text-gray-700 text-center leading-tight font-black';
      name.textContent = item.name;
      card.appendChild(name);

      if (needsClean) {
        card.onclick = (ev) => { ev.stopPropagation(); cleanItem(item.id); };
      } else {
        card.onclick = null;
      }

      // pointer down drag (only if clean)
      card.onpointerdown = (e) => {
        if (currentGame.isPaused) return;
        if (item.needsCleaning && !item.isCleaned) return;

        e.preventDefault();
        card.setPointerCapture?.(e.pointerId);

        const rect = card.getBoundingClientRect();
        const tray = document.getElementById("trash-tray");

        dragState = {
          item,
          card,
          originalParent: tray,
          offsetX: e.clientX - rect.left,
          offsetY: e.clientY - rect.top
        };

        card.classList.add("dragging");
        card.style.position = "fixed";
        card.style.left = rect.left + "px";
        card.style.top  = rect.top + "px";
        card.style.zIndex = "1000";
        document.body.appendChild(card);
      };

      return card;
    }

    function cleanItem(itemId) {
      const item = currentGame.trashItems.find(i => i.id === itemId);
      if (item && !item.isCleaned) {
        item.isCleaned = true;

        const card = document.querySelector(`[data-id="${itemId}"]`);
        const overlay = card?.querySelector('.clean-overlay');
        if (overlay) {
          overlay.remove();
          playSfx("clean", 0.85);
          showToast('Cleaned!');
          const r = card.getBoundingClientRect();
          createSparkle(r.left + 35, r.top + 35, '#3b82f6');
        }

        card.onclick = null;

        const itemData = currentGame.trashItems.find(i => i.id === itemId);
        card.onpointerdown = (e) => {
          if (currentGame.isPaused) return;
          if (itemData.needsCleaning && !itemData.isCleaned) return;

          e.preventDefault();
          card.setPointerCapture?.(e.pointerId);

          const rect = card.getBoundingClientRect();
          const tray = document.getElementById("trash-tray");

          dragState = {
            item: itemData,
            card,
            originalParent: tray,
            offsetX: e.clientX - rect.left,
            offsetY: e.clientY - rect.top
          };

          card.classList.add("dragging");
          card.style.position = "fixed";
          card.style.left = rect.left + "px";
          card.style.top  = rect.top + "px";
          card.style.zIndex = "1000";
          document.body.appendChild(card);
        };
      }
    }

    function handleDrop(item, binCategory, card, bin) {
      const isCorrect = item.category === binCategory;

      if (item.needsCleaning && !item.isCleaned) {
        showToast('Clean this first!');
        returnCardToTray(card, document.getElementById('trash-tray'));
        return;
      }

      if (isCorrect) {
        playSfx("correct", 0.9);

        const basePoints = 10;
        const streakMultiplier = Math.min(currentGame.streak + 1, 5);
        const points = basePoints * streakMultiplier;

        currentGame.score += points;
        currentGame.streak++;
        currentGame.coinsEarned += Math.floor(points / 5);

        const r = card.getBoundingClientRect();
        createSparkle(r.left + 35, r.top + 35);

        card.remove();
        currentGame.trashItems = currentGame.trashItems.filter(i => i.id !== item.id);
        updateGameUI();

        if (currentGame.trashItems.length === 0) {
          if (currentGame.currentWave < currentGame.config.waves) {
            currentGame.currentWave++;
            showToast(`Wave ${currentGame.currentWave}!`);
            setTimeout(spawnWave, 900);
          } else {
            endGame(true);
          }
        }
      } else {
        playSfx("wrong", 0.9);

        if (currentGame.shieldActive) {
          currentGame.shieldActive = false;
          document.getElementById('shield-active').classList.add('hidden');
          showToast('Shield blocked penalty!');
        } else {
          currentGame.contamination += currentGame.config.contaminationPenalty;
          if (currentGame.contamination >= 100) {
            endGame(false, 'Too much contamination!');
            return;
          }
        }

        currentGame.streak = 0;

        bin.classList.add('wrong');
        setTimeout(() => bin.classList.remove('wrong'), 500);

        returnCardToTray(card, document.getElementById('trash-tray'));
        updateGameUI();
      }
    }

    function returnCardToTray(card, tray) {
      card.style.position = '';
      card.style.left = '';
      card.style.top = '';
      card.style.zIndex = '';
      tray.appendChild(card);
    }

    function updateGameUI() {
      document.getElementById('game-score').textContent = currentGame.score;
      document.getElementById('level-display').textContent = currentGame.level;
      document.getElementById('wave-display').textContent = `${currentGame.currentWave}/${currentGame.config.waves}`;

      const streakDisplay = document.getElementById('streak-display');
      if (currentGame.streak > 0) {
        streakDisplay.classList.remove('hidden');
        document.getElementById('streak-count').textContent = `x${Math.min(currentGame.streak, 5)}`;
      } else {
        streakDisplay.classList.add('hidden');
      }

      document.getElementById('contamination-bar').style.width = `${currentGame.contamination}%`;
      document.getElementById('contamination-percent').textContent = `${Math.round(currentGame.contamination)}%`;
    }

    function updateBoostButtons() {
      const boosts = ['hint', 'shield', 'vacuum', 'freeze'];
      boosts.forEach(type => {
        const btn = document.getElementById(`boost-${type}`);
        const count = document.getElementById(`${type}-count`);
        count.textContent = gameState.boosts[type];
        btn.disabled = gameState.boosts[type] <= 0;
      });
    }

    function useBoost(type) {
      if (gameState.boosts[type] <= 0) return;

      gameState.boosts[type]--;
      saveGame();
      updateBoostButtons();

      switch (type) {
        case 'hint': useHint(); break;
        case 'shield':
          currentGame.shieldActive = true;
          document.getElementById('shield-active').classList.remove('hidden');
          document.getElementById('shield-active').classList.add('flex');
          showToast('Shield activated!');
          break;
        case 'vacuum': useVacuum(); break;
        case 'freeze': useFreeze(); break;
      }
    }

    function useHint() {
      if (currentGame.trashItems.length === 0) return;
      const item = currentGame.trashItems[0];
      const card = document.querySelector(`[data-id="${item.id}"]`);
      const bin = document.querySelector(`[data-bin="${item.category}"]`);

      if (card && bin) {
        bin.classList.add('pulse-glow');
        card.style.outline = '3px solid #22c55e';

        setTimeout(() => {
          bin.classList.remove('pulse-glow');
          if (card) card.style.outline = '';
        }, 2500);

        showToast(`Hint: ${item.name}`);
      }
    }

    function useVacuum() {
      if (currentGame.trashItems.length === 0) return;

      const item = currentGame.trashItems[Math.floor(Math.random() * currentGame.trashItems.length)];
      const card = document.querySelector(`[data-id="${item.id}"]`);
      const bin = document.querySelector(`[data-bin="${item.category}"]`);

      if (card && bin) {
        const cardRect = card.getBoundingClientRect();
        const binRect = bin.getBoundingClientRect();

        card.style.position = 'fixed';
        card.style.left = cardRect.left + 'px';
        card.style.top = cardRect.top + 'px';
        card.style.zIndex = '1000';
        card.style.transition = 'all 0.5s ease';
        document.body.appendChild(card);

        setTimeout(() => {
          card.style.left = (binRect.left + binRect.width/2 - 35) + 'px';
          card.style.top = (binRect.top + 6) + 'px';
          card.style.transform = 'scale(0)';
        }, 50);

        setTimeout(() => {
          card.remove();
          currentGame.trashItems = currentGame.trashItems.filter(i => i.id !== item.id);
          currentGame.score += 10;
          updateGameUI();

          createSparkle(binRect.left + binRect.width/2, binRect.top + binRect.height/2);

          if (currentGame.trashItems.length === 0) {
            if (currentGame.currentWave < currentGame.config.waves) {
              currentGame.currentWave++;
              setTimeout(spawnWave, 900);
            } else {
              endGame(true);
            }
          }
        }, 600);

        showToast('Vacuum!');
      }
    }

    function useFreeze() {
      currentGame.isFreezed = true;
      showToast('Time frozen!');

      document.getElementById('game-screen').style.boxShadow = 'inset 0 0 100px rgba(59, 130, 246, 0.5)';

      setTimeout(() => {
        currentGame.isFreezed = false;
        document.getElementById('game-screen').style.boxShadow = '';
        showToast('Time resumed!');
      }, 5000);
    }

    function endGame(won, message = '') {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      const modal = document.getElementById('result-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      if (won) {
        playSfx("win", 0.9);

        let stars = 1;
        if (currentGame.contamination < 30) stars++;
        if (currentGame.streak >= 3 || currentGame.score >= currentGame.config.totalTrash * 15) stars++;

        if (currentGame.config.timerType === 'soft' && currentGame.timer > 0) {
          currentGame.coinsEarned += Math.floor(currentGame.timer / 2);
        }

        gameState.coins += currentGame.coinsEarned;
        gameState.levelStars[currentGame.level] = Math.max(gameState.levelStars[currentGame.level] || 0, stars);
        gameState.highestUnlocked = Math.max(gameState.highestUnlocked, currentGame.level + 1);

        document.getElementById('result-emoji').textContent = stars === 3 ? 'üèÜ' : stars === 2 ? 'üéâ' : '‚úÖ';
        document.getElementById('result-title').textContent = 'Level Complete!';
        document.getElementById('result-message').textContent = stars === 3 ? 'Perfect!' : stars === 2 ? 'Great job!' : 'Keep improving!';

        const starEls = document.querySelectorAll('#result-stars .star');
        starEls.forEach((el, i) => {
          setTimeout(() => {
            if (i < stars) {
              el.classList.remove('empty');
              el.classList.add('earned');
            } else {
              el.classList.add('empty');
              el.classList.remove('earned');
            }
          }, i * 250);
        });

        document.getElementById('next-level-btn').classList.remove('hidden');
      } else {
        playSfx("lose", 0.9);

        document.getElementById('result-emoji').textContent = 'üò¢';
        document.getElementById('result-title').textContent = 'Level Failed';
        document.getElementById('result-message').textContent = message || 'Try again!';

        document.querySelectorAll('#result-stars .star').forEach(el => {
          el.classList.add('empty');
          el.classList.remove('earned');
        });

        document.getElementById('next-level-btn').classList.add('hidden');
      }

      document.getElementById('result-score').textContent = currentGame.score;
      document.getElementById('result-coins').textContent = `+${currentGame.coinsEarned}`;

      saveGame();
      updateAllCoinDisplays();

      playBgm();
    }

    function nextLevel() {
      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');

      if (currentGame.level < 30) startLevel(currentGame.level + 1);
      else { showToast('You completed all levels!'); showScreen('map-screen'); }
    }

    function restartLevel() {
      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');

      startLevel(currentGame.level);
    }

    function pauseGame() {
      currentGame.isPaused = true;
      document.getElementById('pause-modal').classList.remove('hidden');
      document.getElementById('pause-modal').classList.add('flex');
      playBgm();
    }

    function resumeGame() {
      currentGame.isPaused = false;
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');
      playBgm();
    }

    function quitToMap() {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');

      showScreen('map-screen');
      playBgm();
    }

    // Element SDK (no editable title text now)
    const defaultConfig = { game_title: 'EcoRush' };
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {},
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['game_title', config.game_title || defaultConfig.game_title]
        ])
      });
    }

    loadGame();

    if (gameState.coins === 0 && Object.keys(gameState.levelStars).length === 0) {
      gameState.coins = 100;
      gameState.boosts.hint = 2;
      gameState.boosts.shield = 1;
      saveGame();
    }

    updateAllCoinDisplays();

    // ‚úÖ Apply local UI icons (auto) from ui-icons/<data-icon>.png
    applyAllUiIcons();

    // ‚úÖ Ensure BGM attempts early (will succeed after gesture)
    initBgm();
    playBgm();
  </script>
</body>
</html>
