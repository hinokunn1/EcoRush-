<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>EcoRush: Barangay Cleanup Challenge</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      overflow: hidden;
      user-select: none;
      margin: 0;
      padding: 0;
    }
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700;800&display=swap');

    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #10b981 0%, #0d9488 50%, #0891b2 100%);
    }
    .game-font { font-family: 'Fredoka', sans-serif; }

    /* BACKGROUND IMAGES (LOCAL REPO PATHS) */
    .bg-home    { background: url("background-ui/home.png") center/cover no-repeat; }
    .bg-map     { background: url("background-ui/map.png") center/cover no-repeat; }
    .bg-tutorial{ background: url("background-ui/tutorial.png") center/cover no-repeat; }
    .bg-shop    { background: url("background-ui/shop.png") center/cover no-repeat; }

    .bg-game-easy    { background: url("background-ui/game-easy.png") center/cover no-repeat; }
    .bg-game-normal  { background: url("background-ui/game-normal.png") center/cover no-repeat; }
    .bg-game-hard    { background: url("background-ui/game-hard.png") center/cover no-repeat; }
    .bg-game-extreme { background: url("background-ui/game-extreme.png") center/cover no-repeat; }

    /* overlay for readability */
    .screen::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.55));
      pointer-events:none;
      z-index:0;
    }
    .screen > *{ position:relative; z-index:1; }

    /* title background (kept, not required now) */
    .title-bg{
      background: url("background-ui/title.png") center/cover no-repeat;
      padding: 20px 30px;
      border-radius: 30px;
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.0);
      display:inline-block;
      backdrop-filter: blur(0px);
    }

    /* ANIMATIONS */
    @keyframes shake {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      20% { transform: translateX(-12px) rotate(-3deg); }
      40% { transform: translateX(12px) rotate(3deg); }
      60% { transform: translateX(-12px) rotate(-3deg); }
      80% { transform: translateX(12px) rotate(3deg); }
    }
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
      100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5), inset 0 0 20px rgba(34, 197, 94, 0.2); }
      50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8), inset 0 0 30px rgba(34, 197, 94, 0.3); }
    }
    @keyframes slide-up {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pop-in {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      70% { transform: scale(1.1); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes bounce-in {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    @keyframes toast-slide {
      from { transform: translateY(-120%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes timer-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* UTILITY CLASSES */
    .bin { transition: all 0.2s ease; position: relative; overflow: hidden; }
    .bin.highlight {
      transform: scale(1.12);
      box-shadow: 0 0 30px rgba(255,255,255,0.7), inset 0 0 20px rgba(255,255,255,0.3);
    }
    .bin.wrong { animation: shake 0.5s ease; }

    .trash-card {
      transition: all 0.15s ease;
      touch-action: none;
      cursor: grab;
      position: relative;
      overflow: hidden;
    }
    .trash-card:active { cursor: grabbing; }
    .trash-card.dragging {
      transform: scale(1.15) rotate(8deg);
      box-shadow: 0 25px 50px rgba(0,0,0,0.4);
      z-index: 1000;
      filter: brightness(1.1);
    }
    .trash-card.correct { animation: pop-in 0.5s ease forwards; }
    .sparkle { animation: sparkle 0.7s ease-out forwards; pointer-events: none; }
    .float { animation: float 2.5s ease-in-out infinite; }
    .pulse-glow { animation: pulse-glow 1.5s ease-in-out infinite; }
    .slide-up { animation: slide-up 0.3s ease forwards; }
    .pop-in { animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
    .bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
    .toast { animation: toast-slide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

    .star { transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .star.earned {
      color: #fbbf24;
      text-shadow: 0 0 25px rgba(251, 191, 36, 0.9), 0 0 50px rgba(251, 191, 36, 0.6);
      animation: bounce-in 0.5s ease forwards;
    }
    .star.empty { color: #6b7280; opacity: 0.3; }

    .contamination-bar {
      transition: all 0.3s ease;
      background: linear-gradient(90deg, #f59e0b, #ef4444, #991b1b);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .level-node { transition: all 0.2s ease; border-radius: 16px; position: relative; overflow: hidden; }
    .level-node:not(.locked) { cursor: pointer; }
    .level-node:not(.locked):active { transform: scale(0.92); }
    .level-node.locked { filter: grayscale(1) brightness(0.5); opacity: 0.7; }
    .level-node::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .level-node:not(.locked):hover::before { opacity: 1; }

    .screen {
      display: none;
      height: 100%;
      width: 100%;
      flex-direction: column;
      overflow-y: auto;
      position: absolute;
      inset: 0;
    }
    .screen.active { display: flex; }

    .boost-btn { transition: all 0.15s ease; border: 2px solid rgba(255,255,255,0.3); }
    .boost-btn:not(:disabled) { cursor: pointer; }
    .boost-btn:not(:disabled):active { transform: scale(0.92); }
    .boost-btn:disabled { opacity: 0.4; filter: grayscale(0.7); }

    .clean-overlay { animation: pulse 0.8s infinite; background: linear-gradient(135deg, rgba(202, 138, 4, 0.9), rgba(177, 98, 0, 0.9)); }
    .timer-critical { animation: timer-pulse 0.5s ease infinite; color: #fca5a5; font-weight: 800; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

    /* =========================
       ‚úÖ HOME (TITLE IMAGE + BETTER BUTTONS)
       ========================= */
    @keyframes homeFloat {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes sheen {
      0% { transform: translateX(-120%) skewX(-20deg); opacity: 0; }
      25% { opacity: .35; }
      60% { opacity: .15; }
      100% { transform: translateX(220%) skewX(-20deg); opacity: 0; }
    }

    .home-title-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom: 1.1rem;
      animation: homeFloat 3s ease-in-out infinite;
    }
    .home-title-img{
      width: min(340px, 84vw);
      height: auto;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      user-select:none;
      pointer-events:none;
    }

    .home-btn{
      position: relative;
      width: 100%;
      padding: 1rem 1.25rem;
      border-radius: 1.25rem;
      font-weight: 800;
      font-size: 1.125rem;
      color: white;
      box-shadow: 0 16px 28px rgba(0,0,0,.28);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
      overflow:hidden;
      border: 2px solid rgba(255,255,255,.22);
      backdrop-filter: blur(6px);
    }
    .home-btn:active{
      transform: scale(.97);
      filter: brightness(.98);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .home-btn:hover{
      transform: scale(1.02);
      box-shadow: 0 20px 34px rgba(0,0,0,.32);
    }
    .home-btn::after{
      content:"";
      position:absolute;
      top:-40%;
      left:-40%;
      width: 40%;
      height: 180%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      opacity: 0;
    }
    .home-btn:hover::after{
      opacity: 1;
      animation: sheen 1.25s ease forwards;
    }
    .home-btn-inner{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.75rem;
      position:relative;
      z-index:1;
    }
    .home-icon{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    .home-icon span{ font-size: 20px; line-height: 1; }
    .home-sub{
      color: rgba(236, 253, 245, .92);
      text-shadow: 0 6px 14px rgba(0,0,0,.35);
    }
    .home-pill{
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
    }
  </style>

  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>

<body class="h-full w-full game-font overflow-hidden">
  <div id="app" class="h-full w-full relative flex flex-col">

    <!-- HOME SCREEN -->
    <div id="home-screen" class="screen active bg-home flex flex-col items-center justify-center p-6 text-center min-h-screen">

      <!-- TITLE IMAGE ONLY -->
      <div class="home-title-wrap">
        <img src="background-ui/title.png" alt="EcoRush" class="home-title-img" />
      </div>

  

      <!-- BUTTONS -->
      <div class="space-y-4 w-full max-w-xs mb-10">

        <button onclick="showScreen('map-screen')"
          class="home-btn"
          style="background: linear-gradient(135deg, #22c55e 0%, #10b981 45%, #059669 100%);">
          <div class="home-btn-inner">
            <div class="home-icon"><span>üéÆ</span></div>
            <span>Play</span>
          </div>
        </button>

        <button onclick="showScreen('shop-screen')"
          class="home-btn"
          style="background: linear-gradient(135deg, #f59e0b 0%, #fb923c 55%, #f97316 100%);">
          <div class="home-btn-inner">
            <div class="home-icon"><span>üõí</span></div>
            <span>Shop</span>
          </div>
        </button>

        <button onclick="showScreen('tutorial-screen')"
          class="home-btn"
          style="background: linear-gradient(135deg, rgba(255,255,255,.20) 0%, rgba(255,255,255,.08) 100%);">
          <div class="home-btn-inner">
            <div class="home-icon"><span>üìñ</span></div>
            <span>How to Play</span>
          </div>
        </button>

      </div>

      <!-- COINS & LIVES -->
      <div class="flex gap-6 text-center">
        <div class="home-pill flex items-center gap-3 bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-3 rounded-full shadow-lg">
          <span class="text-3xl">ü™ô</span>
          <span id="home-coins" class="text-2xl font-bold text-white">0</span>
        </div>
        <div class="home-pill flex items-center gap-3 bg-gradient-to-r from-red-500 to-pink-500 px-6 py-3 rounded-full shadow-lg">
          <span class="text-2xl" id="home-lives-icon">‚ù§Ô∏è</span>
          <span id="home-lives" class="text-2xl font-bold text-white">5</span>
        </div>
      </div>
    </div>

    <!-- TUTORIAL SCREEN -->
    <div id="tutorial-screen" class="screen bg-tutorial flex-col p-4">
      <div class="flex items-center justify-between mb-4">
        <button onclick="showScreen('home-screen')" class="p-2 bg-white/20 rounded-full"><span class="text-xl">‚Üê</span></button>
        <h2 class="text-xl font-bold text-white drop-shadow">How to Play</h2>
        <div class="w-10"></div>
      </div>

      <div class="flex-1 overflow-y-auto space-y-4 pb-4">
        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-2">üéØ Goal</h3>
          <p class="text-emerald-100">Sort all trash items into the correct bins before time runs out!</p>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-2">üóëÔ∏è The 4 Bins</h3>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">ü•¨</span>
              <span class="text-emerald-100"><strong>Biodegradable</strong> - Food scraps, plant waste</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">‚ôªÔ∏è</span>
              <span class="text-emerald-100"><strong>Recyclable</strong> - Clean plastic, metal, paper</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 bg-gray-500 rounded-lg flex items-center justify-center">üóëÔ∏è</span>
              <span class="text-emerald-100"><strong>Residual</strong> - Non-recyclable waste</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">‚ò†Ô∏è</span>
              <span class="text-emerald-100"><strong>Hazardous</strong> - Batteries, chemicals</span>
            </div>
          </div>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-2">‚ö° Tips</h3>
          <ul class="text-emerald-100 text-sm space-y-1">
            <li>‚Ä¢ Build streaks for bonus points!</li>
            <li>‚Ä¢ Some items need cleaning first - tap them!</li>
            <li>‚Ä¢ Watch the contamination meter!</li>
            <li>‚Ä¢ Buy boosts in the shop!</li>
          </ul>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-2">üöÄ Boosts</h3>
          <div class="space-y-2 text-sm text-emerald-100">
            <p><strong>üí° Hint</strong> - Shows the correct bin</p>
            <p><strong>üõ°Ô∏è Shield</strong> - Blocks next penalty</p>
            <p><strong>üåÄ Vacuum</strong> - Auto-sorts one item</p>
            <p><strong>‚ùÑÔ∏è Freeze</strong> - Stops the timer</p>
          </div>
        </div>
      </div>
    </div>

    <!-- MAP SCREEN -->
    <div id="map-screen" class="screen bg-map flex-col p-4">
      <div class="flex items-center justify-between mb-4">
        <button onclick="showScreen('home-screen')" class="p-2 bg-white/20 rounded-full"><span class="text-xl">‚Üê</span></button>
        <h2 class="text-xl font-bold text-white drop-shadow">Select Level</h2>
        <button onclick="showScreen('shop-screen')" class="p-2 bg-amber-500/30 rounded-full"><span class="text-xl">üõí</span></button>
      </div>

      <div class="flex items-center gap-2 bg-black/20 px-4 py-2 rounded-full mb-4 self-center">
        <span class="text-xl">ü™ô</span>
        <span id="map-coins" class="text-lg font-bold text-amber-300">0</span>
      </div>

      <div id="level-grid" class="flex-1 overflow-y-auto pb-4 space-y-6"></div>
    </div>

    <!-- SHOP SCREEN -->
    <div id="shop-screen" class="screen bg-shop flex-col p-4">
      <div class="flex items-center justify-between mb-4">
        <button onclick="showScreen('home-screen')" class="p-2 bg-white/20 rounded-full"><span class="text-xl">‚Üê</span></button>
        <h2 class="text-xl font-bold text-white drop-shadow">Shop</h2>
        <div class="w-10"></div>
      </div>

      <div class="flex items-center gap-2 bg-black/20 px-4 py-2 rounded-full mb-4 self-center">
        <span class="text-xl">ü™ô</span>
        <span id="shop-coins" class="text-lg font-bold text-amber-300">0</span>
      </div>

      <div class="flex-1 overflow-y-auto space-y-3 pb-4">
        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-3">üéí Your Inventory</h3>
          <div id="inventory-display" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white/10 rounded-2xl p-4 backdrop-blur-sm">
          <h3 class="text-lg font-bold text-white mb-3">üõçÔ∏è Buy Boosts</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="text-3xl">üí°</span>
                <div>
                  <p class="font-bold text-white">Hint</p>
                  <p class="text-xs text-emerald-200">Shows correct bin</p>
                </div>
              </div>
              <button onclick="buyBoost('hint')" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-xl flex items-center gap-1">
                <span>50</span><span class="text-sm">ü™ô</span>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="text-3xl">üõ°Ô∏è</span>
                <div>
                  <p class="font-bold text-white">Shield</p>
                  <p class="text-xs text-emerald-200">Blocks next penalty</p>
                </div>
              </div>
              <button onclick="buyBoost('shield')" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-xl flex items-center gap-1">
                <span>80</span><span class="text-sm">ü™ô</span>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="text-3xl">üåÄ</span>
                <div>
                  <p class="font-bold text-white">Vacuum</p>
                  <p class="text-xs text-emerald-200">Auto-sorts 1 item</p>
                </div>
              </div>
              <button onclick="buyBoost('vacuum')" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-xl flex items-center gap-1">
                <span>120</span><span class="text-sm">ü™ô</span>
              </button>
            </div>

            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="text-3xl">‚ùÑÔ∏è</span>
                <div>
                  <p class="font-bold text-white">Freeze</p>
                  <p class="text-xs text-emerald-200">Stops timer 5s</p>
                </div>
              </div>
              <button onclick="buyBoost('freeze')" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-xl flex items-center gap-1">
                <span>100</span><span class="text-sm">ü™ô</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen flex-col">

      <!-- Top HUD -->
      <div class="bg-black/30 p-3 flex items-center justify-between backdrop-blur-sm">
        <button onclick="pauseGame()" class="p-2 bg-white/20 rounded-full"><span class="text-lg">‚è∏Ô∏è</span></button>

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-1">
            <span class="text-lg">‚≠ê</span>
            <span id="game-score" class="font-bold text-white">0</span>
          </div>
          <div id="timer-display" class="flex items-center gap-1 hidden">
            <span class="text-lg">‚è±Ô∏è</span>
            <span id="game-timer" class="font-bold text-white">60</span>
          </div>
        </div>

        <div class="flex items-center gap-1 bg-black/30 px-2 py-1 rounded-full">
          <span class="text-sm">ü™ô</span>
          <span id="game-coins" class="text-sm font-bold text-amber-300">0</span>
        </div>
      </div>

      <!-- Streak & Wave Info -->
      <div class="flex justify-between items-center px-3 py-2 bg-black/20">
        <div class="flex items-center gap-2">
          <span class="text-sm text-white">Level</span>
          <span id="level-display" class="font-bold text-amber-300">1</span>
        </div>
        <div id="streak-display" class="flex items-center gap-1 bg-orange-500/30 px-2 py-1 rounded-full hidden">
          <span class="text-sm">üî•</span>
          <span id="streak-count" class="text-sm font-bold text-orange-300">x1</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-white">Wave</span>
          <span id="wave-display" class="font-bold text-cyan-300">1/1</span>
        </div>
      </div>

      <!-- Contamination Bar -->
      <div class="px-3 py-2 bg-black/20">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-xs text-white">‚ò£Ô∏è Contamination</span>
          <span id="contamination-percent" class="text-xs text-red-300">0%</span>
        </div>
        <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
          <div id="contamination-bar" class="h-full contamination-bar" style="width: 0%"></div>
        </div>
      </div>

      <!-- Boosts Bar -->
      <div class="flex justify-center gap-2 px-3 py-2 bg-black/10">
        <button id="boost-hint" onclick="useBoost('hint')" class="boost-btn flex flex-col items-center p-2 bg-purple-500/30 rounded-xl" disabled>
          <span class="text-xl">üí°</span>
          <span class="text-xs text-white" id="hint-count">0</span>
        </button>
        <button id="boost-shield" onclick="useBoost('shield')" class="boost-btn flex flex-col items-center p-2 bg-blue-500/30 rounded-xl" disabled>
          <span class="text-xl">üõ°Ô∏è</span>
          <span class="text-xs text-white" id="shield-count">0</span>
        </button>
        <button id="boost-vacuum" onclick="useBoost('vacuum')" class="boost-btn flex flex-col items-center p-2 bg-green-500/30 rounded-xl" disabled>
          <span class="text-xl">üåÄ</span>
          <span class="text-xs text-white" id="vacuum-count">0</span>
        </button>
        <button id="boost-freeze" onclick="useBoost('freeze')" class="boost-btn flex flex-col items-center p-2 bg-cyan-500/30 rounded-xl" disabled>
          <span class="text-xl">‚ùÑÔ∏è</span>
          <span class="text-xs text-white" id="freeze-count">0</span>
        </button>

        <div id="shield-active" class="hidden items-center px-2 bg-blue-500/50 rounded-lg"><span class="text-sm">üõ°Ô∏è Active</span></div>
      </div>

      <!-- Bins + Tray -->
      <div class="flex-1 flex flex-col justify-between p-3 min-h-0">
        <div id="bins-container" class="grid grid-cols-4 gap-2 mb-3">
          <div class="bin flex flex-col items-center p-2 bg-green-600 rounded-2xl shadow-lg" data-bin="biodegradable">
            <span class="text-2xl mb-1">ü•¨</span>
            <span class="text-xs text-white font-bold text-center leading-tight">Bio</span>
          </div>
          <div class="bin flex flex-col items-center p-2 bg-blue-600 rounded-2xl shadow-lg" data-bin="recyclable">
            <span class="text-2xl mb-1">‚ôªÔ∏è</span>
            <span class="text-xs text-white font-bold text-center leading-tight">Recycle</span>
          </div>
          <div class="bin flex flex-col items-center p-2 bg-gray-600 rounded-2xl shadow-lg" data-bin="residual">
            <span class="text-2xl mb-1">üóëÔ∏è</span>
            <span class="text-xs text-white font-bold text-center leading-tight">Residual</span>
          </div>
          <div class="bin flex flex-col items-center p-2 bg-red-600 rounded-2xl shadow-lg" data-bin="hazardous">
            <span class="text-2xl mb-1">‚ò†Ô∏è</span>
            <span class="text-xs text-white font-bold text-center leading-tight">Hazard</span>
          </div>
        </div>

        <div id="trash-tray" class="flex-1 bg-black/20 rounded-2xl p-3 overflow-hidden flex flex-wrap content-start gap-2 justify-center"></div>
      </div>
    </div>

    <!-- PAUSE MODAL -->
    <div id="pause-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6 z-50">
      <div class="bg-gradient-to-br from-emerald-700 to-teal-800 rounded-3xl p-6 w-full max-w-sm text-center pop-in">
        <h2 class="text-2xl font-bold text-white mb-6">‚è∏Ô∏è Paused</h2>
        <div class="space-y-3">
          <button onclick="resumeGame()" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl">‚ñ∂Ô∏è Resume</button>
          <button onclick="restartLevel()" class="w-full py-3 bg-amber-500 text-white font-bold rounded-xl">üîÑ Restart</button>
          <button onclick="quitToMap()" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl">üö™ Quit</button>
        </div>
      </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6 z-50">
      <div class="bg-gradient-to-br from-emerald-700 to-teal-800 rounded-3xl p-6 w-full max-w-sm text-center pop-in">
        <div id="result-emoji" class="text-6xl mb-4">üéâ</div>
        <h2 id="result-title" class="text-2xl font-bold text-white mb-2">Level Complete!</h2>
        <p id="result-message" class="text-emerald-200 mb-4">Great job!</p>

        <div id="result-stars" class="flex justify-center gap-2 mb-4 text-4xl">
          <span class="star empty">‚≠ê</span>
          <span class="star empty">‚≠ê</span>
          <span class="star empty">‚≠ê</span>
        </div>

        <div class="flex justify-center gap-4 mb-6">
          <div class="bg-black/20 px-4 py-2 rounded-xl">
            <p class="text-xs text-emerald-300">Score</p>
            <p id="result-score" class="text-xl font-bold text-white">0</p>
          </div>
          <div class="bg-black/20 px-4 py-2 rounded-xl">
            <p class="text-xs text-emerald-300">Coins</p>
            <p id="result-coins" class="text-xl font-bold text-amber-300">+0</p>
          </div>
        </div>

        <div class="space-y-3">
          <button id="next-level-btn" onclick="nextLevel()" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl">‚û°Ô∏è Next Level</button>
          <button onclick="restartLevel()" class="w-full py-3 bg-amber-500 text-white font-bold rounded-xl">üîÑ Retry</button>
          <button onclick="quitToMap()" class="w-full py-3 bg-white/20 text-white font-bold rounded-xl">üó∫Ô∏è Map</button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-full hidden z-50">
      <span id="toast-text">Message</span>
    </div>

    <!-- Sparkle Container -->
    <div id="sparkles" class="fixed inset-0 pointer-events-none z-40"></div>
  </div>

  <script>
    // =========================================================
    // ‚úÖ TRASH ICONS: EASY MODE
    // - Put images in: trash-icons/
    // - Name files SAME AS item.name but slugified:
    //   "Banana Peel" -> trash-icons/banana-peel.webp
    // - If icon not found, auto fallback to Twemoji, then emoji text
    // =========================================================

    const TRASH_ICON_FOLDER = "trash-icons";

    function slugify(name) {
      return name
        .toLowerCase()
        .trim()
        .replace(/['"]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function getTrashIconSrc(item) {
      return `${TRASH_ICON_FOLDER}/${slugify(item.name)}.png`;
    }

    function getEmojiImageSrc(emoji) {
      const codePoints = Array.from(emoji)
        .map(char => char.codePointAt(0).toString(16))
        .filter(code => code !== "fe0f");
      return `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/${codePoints.join("-")}.png`;
    }

    function getDifficultyName(level){
      if (level <= 5) return "easy";
      if (level <= 15) return "normal";
      if (level <= 25) return "hard";
      return "extreme";
    }

    function applyGameBackground(level){
      const gameScreen = document.getElementById("game-screen");
      gameScreen.classList.remove("bg-game-easy","bg-game-normal","bg-game-hard","bg-game-extreme");
      gameScreen.classList.add(`bg-game-${getDifficultyName(level)}`);
    }

    // ========== TRASH DATABASE ==========
    // NOTE: imageSrc is no longer needed. Just add the name + emoji.
    const TRASH_DATABASE = {
      biodegradable: [
        { name: "Banana Peel", emoji: "üçå" },
        { name: "Leftover Rice", emoji: "üçö" },
        { name: "Fish Bones", emoji: "üêü" },
        { name: "Chicken Bones", emoji: "üçó" },
        { name: "Mango Seed", emoji: "ü•≠" },
        { name: "Coconut Husk", emoji: "ü••" },
        { name: "Vegetable Peels", emoji: "ü•ï" },
        { name: "Corn Cob", emoji: "üåΩ" },
        { name: "Egg Shells", emoji: "ü•ö" },
        { name: "Calamansi Peel", emoji: "üçã" },
        { name: "Used Tea Leaves", emoji: "üçµ" },
        { name: "Coffee Grounds", emoji: "‚òï" },
        { name: "Wilted Leaves", emoji: "üçÇ" },
        { name: "Bread Leftover", emoji: "üçû" },
        { name: "Fruit Peels", emoji: "üçä" },
        { name: "Pineapple Crown", emoji: "üçç" },
        { name: "Watermelon Rind", emoji: "üçâ" },
        { name: "Peanut Shells", emoji: "ü•ú" }
      ],
      recyclable: [
        { name: "Water Bottle", emoji: "üß¥" },
        { name: "Soft Drink Bottle", emoji: "üçæ" },
        { name: "Sardines Can", emoji: "ü•´" },
        { name: "Tuna Can", emoji: "ü•´" },
        { name: "Glass Bottle", emoji: "üç∂" },
        { name: "Aluminum Can", emoji: "ü•§" },
        { name: "Shopee Box", emoji: "üì¶" },
        { name: "Lazada Box", emoji: "üì¶" },
        { name: "Newspaper", emoji: "üì∞" },
        { name: "Cardboard", emoji: "üìã" },
        { name: "Paper Bag", emoji: "üõçÔ∏è" },
        { name: "Clean Plastic Container", emoji: "ü´ô" },
        { name: "Detergent Bottle", emoji: "üß¥", needsCleaning: true },
        { name: "Glass Jar", emoji: "ü´ô" },
        { name: "Metal Lid", emoji: "‚≠ï" },
        { name: "Milk Carton", emoji: "ü•õ", needsCleaning: true },
        { name: "Magazine", emoji: "üìñ" },
        { name: "Office Paper", emoji: "üìÑ" }
      ],
      residual: [
        { name: "Used Diaper", emoji: "üë∂" },
        { name: "Candy Wrapper", emoji: "üç¨" },
        { name: "Chip Bag", emoji: "ü•î" },
        { name: "Styrofoam Plate", emoji: "üçΩÔ∏è" },
        { name: "Plastic Straw", emoji: "ü•§" },
        { name: "Dirty Plastic Bag", emoji: "üõçÔ∏è" },
        { name: "Broken Tsinelas", emoji: "ü©¥" },
        { name: "Old Sponge", emoji: "üßΩ" },
        { name: "Used Tissue", emoji: "üßª" },
        { name: "Old Toothbrush", emoji: "ü™•" },
        { name: "Broken Ceramic", emoji: "üè∫" },
        { name: "Sachet Wrapper", emoji: "üì¶" },
        { name: "Used Face Mask", emoji: "üò∑" },
        { name: "Wet Wipes", emoji: "üß¥" },
        { name: "Used Tape", emoji: "üìé" },
        { name: "Dirty Paper Cup", emoji: "ü•§" },
        { name: "Cigarette Butt", emoji: "üö¨" },
        { name: "Rubber Band", emoji: "‚≠ï" }
      ],
      hazardous: [
        { name: "AA Battery", emoji: "üîã" },
        { name: "Phone Battery", emoji: "üì±" },
        { name: "Light Bulb", emoji: "üí°" },
        { name: "Mosquito Spray", emoji: "ü¶ü" },
        { name: "Bleach Bottle", emoji: "üß¥" },
        { name: "Pesticide Bottle", emoji: "‚ò†Ô∏è" },
        { name: "Medicine Blister", emoji: "üíä" },
        { name: "Expired Medicine", emoji: "üíä" },
        { name: "Nail Polish", emoji: "üíÖ" },
        { name: "Aerosol Can", emoji: "üß¥" },
        { name: "Old Charger", emoji: "üîå" },
        { name: "Broken Thermometer", emoji: "üå°Ô∏è" },
        { name: "Ink Cartridge", emoji: "üñ®Ô∏è" },
        { name: "Paint Can", emoji: "üé®" },
        { name: "Motor Oil", emoji: "üõ¢Ô∏è" },
        { name: "Fluorescent Tube", emoji: "üí°" },
        { name: "Car Battery", emoji: "üöó" },
        { name: "Broken Phone", emoji: "üì±" }
      ]
    };

    const DECOY_ITEMS = [
      { name: "Dirty Water Bottle", emoji: "üß¥", category: "residual", looksLike: "recyclable" },
      { name: "Clean Paper Cup", emoji: "ü•§", category: "recyclable", looksLike: "residual", needsCleaning: true },
      { name: "Greasy Pizza Box", emoji: "üì¶", category: "residual", looksLike: "recyclable" },
      { name: "Clean Styrofoam", emoji: "üì¶", category: "residual", looksLike: "recyclable" }
    ];

    function getLevelConfig(level) {
      let trashCount = 5 + Math.floor(level * 0.8);
      let hazardChance = Math.min(0.1 + level * 0.01, 0.4);
      let contaminationPenalty = 10 + Math.floor(level * 0.5);
      let timer = 0;
      let timerType = 'none';
      let waves = 1;
      let useDecoys = level >= 6;

      if (level >= 7 && level <= 9) {
        timer = 60 + (level - 7) * 10;
        timerType = 'soft';
      } else if (level >= 10) {
        timer = Math.max(40, 90 - (level - 10) * 2);
        timerType = 'hard';
      }

      if (level >= 8 && level <= 15) waves = 2;
      else if (level >= 16) waves = 3;

      const trashPerWave = Math.ceil(trashCount / waves);

      return {
        level,
        trashPerWave,
        totalTrash: trashPerWave * waves,
        hazardChance,
        contaminationPenalty,
        timer,
        timerType,
        waves,
        useDecoys
      };
    }

    let gameState = {
      coins: 0,
      levelStars: {},
      highestUnlocked: 1,
      boosts: { hint: 0, shield: 0, vacuum: 0, freeze: 0 }
    };

    let currentGame = {
      level: 1,
      config: null,
      score: 0,
      streak: 0,
      contamination: 0,
      currentWave: 1,
      trashItems: [],
      timer: 0,
      timerInterval: null,
      isPaused: false,
      isFreezed: false,
      shieldActive: false,
      coinsEarned: 0
    };

    function saveGame() {
      localStorage.setItem('ecoRushSave', JSON.stringify(gameState));
    }

    function loadGame() {
      const saved = localStorage.getItem('ecoRushSave');
      if (saved) {
        const parsed = JSON.parse(saved);
        gameState = { ...gameState, ...parsed };
      }
      updateAllCoinDisplays();
    }

    // ‚úÖ HARD FIX: guarantee ONLY the target screen is visible (prevents home showing behind)
    function showScreen(screenId) {
      const screens = document.querySelectorAll('.screen');
      screens.forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none'; // hard hide
      });

      const target = document.getElementById(screenId);
      target.classList.add('active');
      target.style.display = 'flex'; // hard show

      if (screenId === 'map-screen') renderLevelMap();
      else if (screenId === 'shop-screen') renderShop();

      updateAllCoinDisplays();
    }

    function updateAllCoinDisplays() {
      document.getElementById('home-coins').textContent = gameState.coins;
      document.getElementById('map-coins').textContent = gameState.coins;
      document.getElementById('shop-coins').textContent = gameState.coins;
      document.getElementById('game-coins').textContent = gameState.coins;
    }

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-text').textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('toast');

      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('toast');
      }, duration);
    }

    function createSparkle(x, y, color = '#22c55e') {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle absolute';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      sparkle.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40">
        <path d="M20 0 L23 17 L40 20 L23 23 L20 40 L17 23 L0 20 L17 17 Z" fill="${color}"/>
      </svg>`;
      document.getElementById('sparkles').appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 600);
    }

    function renderLevelMap() {
      const grid = document.getElementById('level-grid');
      grid.innerHTML = '';

      const difficulties = [
        { name: 'üü¢ Easy', range: [1, 5], color: 'from-green-500 to-emerald-600' },
        { name: 'üü° Normal', range: [6, 15], color: 'from-yellow-500 to-amber-600' },
        { name: 'üî¥ Hard', range: [16, 25], color: 'from-red-500 to-orange-600' },
        { name: 'üü£ Extreme', range: [26, 30], color: 'from-purple-600 to-pink-600' }
      ];

      difficulties.forEach(difficulty => {
        const section = document.createElement('div');
        section.className = 'px-4';

        const title = document.createElement('h3');
        title.className = 'text-lg font-bold text-white mb-3 ml-2 drop-shadow';
        title.textContent = difficulty.name;
        section.appendChild(title);

        const levelGrid = document.createElement('div');
        levelGrid.className = 'grid grid-cols-5 gap-2';

        for (let i = difficulty.range[0]; i <= difficulty.range[1]; i++) {
          const stars = gameState.levelStars[i] || 0;
          const isUnlocked = i <= gameState.highestUnlocked;

          const node = document.createElement('button');
          node.className = `level-node aspect-square rounded-xl flex flex-col items-center justify-center text-sm ${
            isUnlocked ? `bg-gradient-to-br ${difficulty.color}` : 'bg-gray-600 locked'
          }`;

          if (isUnlocked) node.onclick = () => startLevel(i);

          node.innerHTML = `
            <span class="font-bold text-white">${i}</span>
            <div class="flex gap-0.5 mt-0.5">
              ${[1, 2, 3].map(s => `<span class="text-xs ${s <= stars ? 'text-amber-300' : 'text-gray-400'}">‚≠ê</span>`).join('')}
            </div>
          `;

          levelGrid.appendChild(node);
        }

        section.appendChild(levelGrid);
        grid.appendChild(section);
      });
    }

    function renderShop() {
      const inventory = document.getElementById('inventory-display');
      inventory.innerHTML = `
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2"><span class="text-2xl">üí°</span><span class="text-white font-bold">${gameState.boosts.hint}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2"><span class="text-2xl">üõ°Ô∏è</span><span class="text-white font-bold">${gameState.boosts.shield}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2"><span class="text-2xl">üåÄ</span><span class="text-white font-bold">${gameState.boosts.vacuum}</span></div>
        <div class="bg-black/20 p-3 rounded-xl flex items-center gap-2"><span class="text-2xl">‚ùÑÔ∏è</span><span class="text-white font-bold">${gameState.boosts.freeze}</span></div>
      `;
    }

    function buyBoost(type) {
      const costs = { hint: 50, shield: 80, vacuum: 120, freeze: 100 };
      const cost = costs[type];

      if (gameState.coins >= cost) {
        gameState.coins -= cost;
        gameState.boosts[type]++;
        saveGame();
        updateAllCoinDisplays();
        renderShop();
        showToast(`Purchased ${type}! üéâ`);
      } else {
        showToast(`Not enough coins! Need ${cost} ü™ô`);
      }
    }

    function startLevel(level) {
      currentGame = {
        level,
        config: getLevelConfig(level),
        score: 0,
        streak: 0,
        contamination: 0,
        currentWave: 1,
        trashItems: [],
        timer: 0,
        timerInterval: null,
        isPaused: false,
        isFreezed: false,
        shieldActive: false,
        coinsEarned: 0
      };

      showScreen('game-screen');
      applyGameBackground(level);

      updateGameUI();
      updateBoostButtons();
      spawnWave();

      if (currentGame.config.timerType !== 'none') {
        currentGame.timer = currentGame.config.timer;
        document.getElementById('timer-display').classList.remove('hidden');
        document.getElementById('game-timer').textContent = currentGame.timer;
        startTimer();
      } else {
        document.getElementById('timer-display').classList.add('hidden');
      }
    }

    function startTimer() {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      currentGame.timerInterval = setInterval(() => {
        if (currentGame.isPaused || currentGame.isFreezed) return;

        currentGame.timer--;
        const timerEl = document.getElementById('game-timer');
        timerEl.textContent = currentGame.timer;

        if (currentGame.timer <= 5 && currentGame.config.timerType !== 'none') {
          timerEl.classList.add('timer-critical');
        } else {
          timerEl.classList.remove('timer-critical');
        }

        if (currentGame.timer <= 0 && currentGame.config.timerType === 'hard') {
          endGame(false, 'Time ran out! ‚è∞');
        }
      }, 1000);
    }

    function spawnWave() {
      const tray = document.getElementById('trash-tray');
      tray.innerHTML = '';
      currentGame.trashItems = [];

      const config = currentGame.config;
      const items = [];

      for (let i = 0; i < config.trashPerWave; i++) {
        let item;

        if (Math.random() < config.hazardChance) {
          item = getRandomItem('hazardous');
        } else if (config.useDecoys && Math.random() < 0.15) {
          item = { ...DECOY_ITEMS[Math.floor(Math.random() * DECOY_ITEMS.length)] };
        } else {
          const categories = ['biodegradable', 'recyclable', 'residual'];
          const cat = categories[Math.floor(Math.random() * categories.length)];
          item = getRandomItem(cat);
        }

        items.push({
          ...item,
          id: `trash-${Date.now()}-${i}`,
          isCleaned: !item.needsCleaning
        });
      }

      currentGame.trashItems = items;

      items.forEach((item, idx) => {
        setTimeout(() => {
          const card = createTrashCard(item);
          tray.appendChild(card);
        }, idx * 100);
      });

      updateGameUI();
    }

    function getRandomItem(category) {
      const items = TRASH_DATABASE[category];
      const item = { ...items[Math.floor(Math.random() * items.length)], category };
      return item;
    }

    function createTrashCard(item) {
      const card = document.createElement('div');
      card.className = 'trash-card bg-white rounded-xl p-2 shadow-lg cursor-grab flex flex-col items-center pop-in';
      card.style.width = '70px';
      card.dataset.id = item.id;
      card.dataset.category = item.category;

      const needsClean = item.needsCleaning && !item.isCleaned;

      const imgDiv = document.createElement('div');
      imgDiv.className = 'relative w-12 h-12 flex items-center justify-center bg-gray-100 rounded-lg mb-1 overflow-hidden';

      const img = document.createElement('img');
      img.src = getTrashIconSrc(item); // ‚úÖ local icon
      img.alt = item.name;
      img.className = 'w-10 h-10 object-contain';
      img.loading = 'lazy';

      img.onerror = function () {
        this.onerror = null;
        this.src = getEmojiImageSrc(item.emoji); // fallback to Twemoji
        this.onerror = function () {
          this.style.display = 'none';
          const fallback = document.createElement('span');
          fallback.textContent = item.emoji;
          fallback.className = 'text-3xl';
          imgDiv.appendChild(fallback);
        };
      };

      imgDiv.appendChild(img);

      if (needsClean) {
        const overlay = document.createElement('div');
        overlay.className = 'clean-overlay absolute inset-0 rounded-lg flex items-center justify-center';
        overlay.innerHTML = '<span class="text-white text-xs font-bold">TAP</span>';
        imgDiv.appendChild(overlay);
      }

      card.appendChild(imgDiv);

      const name = document.createElement('span');
      name.className = 'text-xs text-gray-700 text-center leading-tight font-medium';
      name.textContent = item.name;
      card.appendChild(name);

      if (needsClean) {
        card.onclick = (e) => { e.stopPropagation(); cleanItem(item.id); };
      }

      setupDrag(card, item);
      return card;
    }

    function cleanItem(itemId) {
      const item = currentGame.trashItems.find(i => i.id === itemId);
      if (item && !item.isCleaned) {
        item.isCleaned = true;

        const card = document.querySelector(`[data-id="${itemId}"]`);
        const overlay = card?.querySelector('.clean-overlay');
        if (overlay) {
          overlay.remove();
          showToast('‚ú® Cleaned!');
          const r = card.getBoundingClientRect();
          createSparkle(r.left + 35, r.top + 35, '#3b82f6');
        }

        card.onclick = null;
        const itemData = currentGame.trashItems.find(i => i.id === itemId);
        setupDrag(card, itemData);
      }
    }

    function setupDrag(card, item) {
      let isDragging = false;
      let offsetX, offsetY;
      let originalParent;

      const onStart = (e) => {
        if (item.needsCleaning && !item.isCleaned) return;

        e.preventDefault();
        isDragging = true;
        card.classList.add('dragging');

        const touch = e.touches ? e.touches[0] : e;
        const rect = card.getBoundingClientRect();

        offsetX = touch.clientX - rect.left;
        offsetY = touch.clientY - rect.top;

        originalParent = card.parentElement;

        card.style.position = 'fixed';
        card.style.left = rect.left + 'px';
        card.style.top = rect.top + 'px';
        card.style.zIndex = '1000';
        document.body.appendChild(card);
      };

      const onMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();

        const touch = e.touches ? e.touches[0] : e;
        card.style.left = (touch.clientX - offsetX) + 'px';
        card.style.top = (touch.clientY - offsetY) + 'px';

        document.querySelectorAll('.bin').forEach(bin => {
          const binRect = bin.getBoundingClientRect();
          const cx = touch.clientX, cy = touch.clientY;

          if (cx >= binRect.left && cx <= binRect.right && cy >= binRect.top && cy <= binRect.bottom) {
            bin.classList.add('highlight');
          } else {
            bin.classList.remove('highlight');
          }
        });
      };

      const onEnd = (e) => {
        if (!isDragging) return;
        isDragging = false;
        card.classList.remove('dragging');

        const touch = e.changedTouches ? e.changedTouches[0] : e;

        let droppedBin = null;
        document.querySelectorAll('.bin').forEach(bin => {
          bin.classList.remove('highlight');
          const binRect = bin.getBoundingClientRect();
          if (touch.clientX >= binRect.left && touch.clientX <= binRect.right &&
              touch.clientY >= binRect.top && touch.clientY <= binRect.bottom) {
            droppedBin = bin;
          }
        });

        if (droppedBin) {
          const binCategory = droppedBin.dataset.bin;
          handleDrop(item, binCategory, card, droppedBin);
        } else {
          returnCardToTray(card, originalParent);
        }
      };

      card.onmousedown = null;
      card.ontouchstart = null;

      card.addEventListener('touchstart', onStart, { passive: false });
      card.addEventListener('touchmove', onMove, { passive: false });
      card.addEventListener('touchend', onEnd, { passive: false });

      card.addEventListener('mousedown', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);
    }

    function handleDrop(item, binCategory, card, bin) {
      const isCorrect = item.category === binCategory;

      if (item.needsCleaning && !item.isCleaned) {
        showToast('Clean this first! üëÜ');
        returnCardToTray(card, document.getElementById('trash-tray'));
        return;
      }

      if (isCorrect) {
        const basePoints = 10;
        const streakMultiplier = Math.min(currentGame.streak + 1, 5);
        const points = basePoints * streakMultiplier;

        currentGame.score += points;
        currentGame.streak++;
        currentGame.coinsEarned += Math.floor(points / 5);

        const r = card.getBoundingClientRect();
        createSparkle(r.left + 35, r.top + 35);

        card.remove();
        currentGame.trashItems = currentGame.trashItems.filter(i => i.id !== item.id);
        updateGameUI();

        if (currentGame.trashItems.length === 0) {
          if (currentGame.currentWave < currentGame.config.waves) {
            currentGame.currentWave++;
            showToast(`Wave ${currentGame.currentWave}! üåä`);
            setTimeout(spawnWave, 1000);
          } else {
            endGame(true);
          }
        }
      } else {
        if (currentGame.shieldActive) {
          currentGame.shieldActive = false;
          document.getElementById('shield-active').classList.add('hidden');
          showToast('Shield blocked penalty! üõ°Ô∏è');
        } else {
          currentGame.contamination += currentGame.config.contaminationPenalty;
          if (currentGame.contamination >= 100) {
            endGame(false, 'Too much contamination! ‚ò£Ô∏è');
            return;
          }
        }

        currentGame.streak = 0;

        bin.classList.add('wrong');
        setTimeout(() => bin.classList.remove('wrong'), 500);

        returnCardToTray(card, document.getElementById('trash-tray'));
        updateGameUI();
      }
    }

    function returnCardToTray(card, tray) {
      card.style.position = '';
      card.style.left = '';
      card.style.top = '';
      card.style.zIndex = '';
      card.style.transition = '';
      card.style.transform = '';
      tray.appendChild(card);
    }

    function updateGameUI() {
      document.getElementById('game-score').textContent = currentGame.score;
      document.getElementById('level-display').textContent = currentGame.level;
      document.getElementById('wave-display').textContent = `${currentGame.currentWave}/${currentGame.config.waves}`;

      const streakDisplay = document.getElementById('streak-display');
      if (currentGame.streak > 0) {
        streakDisplay.classList.remove('hidden');
        document.getElementById('streak-count').textContent = `x${Math.min(currentGame.streak, 5)}`;
      } else {
        streakDisplay.classList.add('hidden');
      }

      document.getElementById('contamination-bar').style.width = `${currentGame.contamination}%`;
      document.getElementById('contamination-percent').textContent = `${Math.round(currentGame.contamination)}%`;
    }

    function updateBoostButtons() {
      const boosts = ['hint', 'shield', 'vacuum', 'freeze'];
      boosts.forEach(type => {
        const btn = document.getElementById(`boost-${type}`);
        const count = document.getElementById(`${type}-count`);
        count.textContent = gameState.boosts[type];
        btn.disabled = gameState.boosts[type] <= 0;
      });
    }

    function useBoost(type) {
      if (gameState.boosts[type] <= 0) return;

      gameState.boosts[type]--;
      saveGame();
      updateBoostButtons();

      switch (type) {
        case 'hint': useHint(); break;
        case 'shield':
          currentGame.shieldActive = true;
          document.getElementById('shield-active').classList.remove('hidden');
          document.getElementById('shield-active').classList.add('flex');
          showToast('Shield activated! üõ°Ô∏è');
          break;
        case 'vacuum': useVacuum(); break;
        case 'freeze': useFreeze(); break;
      }
    }

    function useHint() {
      if (currentGame.trashItems.length === 0) return;
      const item = currentGame.trashItems[0];
      const card = document.querySelector(`[data-id="${item.id}"]`);
      const bin = document.querySelector(`[data-bin="${item.category}"]`);

      if (card && bin) {
        bin.classList.add('pulse-glow');
        card.style.outline = '3px solid #22c55e';

        setTimeout(() => {
          bin.classList.remove('pulse-glow');
          if (card) card.style.outline = '';
        }, 3000);

        showToast(`Hint: ${item.name} ‚Üí ${item.category}! üí°`);
      }
    }

    function useVacuum() {
      if (currentGame.trashItems.length === 0) return;

      const item = currentGame.trashItems[Math.floor(Math.random() * currentGame.trashItems.length)];
      const card = document.querySelector(`[data-id="${item.id}"]`);
      const bin = document.querySelector(`[data-bin="${item.category}"]`);

      if (card && bin) {
        const cardRect = card.getBoundingClientRect();
        const binRect = bin.getBoundingClientRect();

        card.style.position = 'fixed';
        card.style.left = cardRect.left + 'px';
        card.style.top = cardRect.top + 'px';
        card.style.zIndex = '1000';
        card.style.transition = 'all 0.5s ease';
        document.body.appendChild(card);

        setTimeout(() => {
          card.style.left = (binRect.left + binRect.width/2 - 35) + 'px';
          card.style.top = binRect.top + 'px';
          card.style.transform = 'scale(0)';
        }, 50);

        setTimeout(() => {
          card.remove();
          currentGame.trashItems = currentGame.trashItems.filter(i => i.id !== item.id);
          currentGame.score += 10;
          updateGameUI();

          createSparkle(binRect.left + binRect.width/2, binRect.top + binRect.height/2);

          if (currentGame.trashItems.length === 0) {
            if (currentGame.currentWave < currentGame.config.waves) {
              currentGame.currentWave++;
              setTimeout(spawnWave, 1000);
            } else {
              endGame(true);
            }
          }
        }, 600);

        showToast('Vacuum! üåÄ');
      }
    }

    function useFreeze() {
      currentGame.isFreezed = true;
      showToast('Time frozen! ‚ùÑÔ∏è');

      document.getElementById('game-screen').style.boxShadow = 'inset 0 0 100px rgba(59, 130, 246, 0.5)';

      setTimeout(() => {
        currentGame.isFreezed = false;
        document.getElementById('game-screen').style.boxShadow = '';
        showToast('Time resumed! ‚è±Ô∏è');
      }, 5000);
    }

    function endGame(won, message = '') {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      const modal = document.getElementById('result-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      if (won) {
        let stars = 1;
        if (currentGame.contamination < 30) stars++;
        if (currentGame.streak >= 3 || currentGame.score >= currentGame.config.totalTrash * 15) stars++;

        if (currentGame.config.timerType === 'soft' && currentGame.timer > 0) {
          currentGame.coinsEarned += Math.floor(currentGame.timer / 2);
        }

        gameState.coins += currentGame.coinsEarned;
        gameState.levelStars[currentGame.level] = Math.max(gameState.levelStars[currentGame.level] || 0, stars);
        gameState.highestUnlocked = Math.max(gameState.highestUnlocked, currentGame.level + 1);

        document.getElementById('result-emoji').textContent = stars === 3 ? 'üèÜ' : stars === 2 ? 'üéâ' : '‚úÖ';
        document.getElementById('result-title').textContent = 'Level Complete!';
        document.getElementById('result-message').textContent = stars === 3 ? 'Perfect!' : stars === 2 ? 'Great job!' : 'Keep improving!';

        const starEls = document.querySelectorAll('#result-stars .star');
        starEls.forEach((el, i) => {
          setTimeout(() => {
            if (i < stars) {
              el.classList.remove('empty');
              el.classList.add('earned');
            } else {
              el.classList.add('empty');
              el.classList.remove('earned');
            }
          }, i * 300);
        });

        document.getElementById('next-level-btn').classList.remove('hidden');
      } else {
        document.getElementById('result-emoji').textContent = 'üò¢';
        document.getElementById('result-title').textContent = 'Level Failed';
        document.getElementById('result-message').textContent = message || 'Try again!';

        document.querySelectorAll('#result-stars .star').forEach(el => {
          el.classList.add('empty');
          el.classList.remove('earned');
        });

        document.getElementById('next-level-btn').classList.add('hidden');
      }

      document.getElementById('result-score').textContent = currentGame.score;
      document.getElementById('result-coins').textContent = `+${currentGame.coinsEarned}`;

      saveGame();
      updateAllCoinDisplays();
    }

    function nextLevel() {
      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');

      if (currentGame.level < 30) startLevel(currentGame.level + 1);
      else { showToast('You completed all levels! üéâ'); showScreen('map-screen'); }
    }

    function restartLevel() {
      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');

      startLevel(currentGame.level);
    }

    function pauseGame() {
      currentGame.isPaused = true;
      document.getElementById('pause-modal').classList.remove('hidden');
      document.getElementById('pause-modal').classList.add('flex');
    }

    function resumeGame() {
      currentGame.isPaused = false;
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');
    }

    function quitToMap() {
      if (currentGame.timerInterval) clearInterval(currentGame.timerInterval);

      document.getElementById('result-modal').classList.add('hidden');
      document.getElementById('result-modal').classList.remove('flex');
      document.getElementById('pause-modal').classList.add('hidden');
      document.getElementById('pause-modal').classList.remove('flex');

      showScreen('map-screen');
    }

    const defaultConfig = { game_title: 'EcoRush' };

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          // ‚úÖ Title is now an image: background-ui/title.png (no text to update)
        },
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['game_title', config.game_title || defaultConfig.game_title]
        ])
      });
    }

    loadGame();

    if (gameState.coins === 0 && Object.keys(gameState.levelStars).length === 0) {
      gameState.coins = 100;
      gameState.boosts.hint = 2;
      gameState.boosts.shield = 1;
      saveGame();
    }

    updateAllCoinDisplays();
  </script>
</body>
</html>
